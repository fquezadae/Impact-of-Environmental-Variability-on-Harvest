.groups = "drop"
) %>%
rename(specie = NOMBRE_ESPECIE) %>%
mutate(harvest_IFOP_loogbook_centrosur = harvest_IFOP_loogbook_centrosur / 1000)
#---- Harvest data merged ----
harvest <- left_join(harvest_SERNAPESCA_v2, harvest_SERNAPESCA, by = c("year", "specie"))
harvest <- left_join(harvest, harvest_IFOP, by = c("year", "specie"))
harvest <- left_join(harvest, harvest_IFOP_logbooks, by = c("year", "specie"))
# Spanish to English month translation
month_translation <- c(
"ene" = "jan", "feb" = "feb", "mar" = "mar", "abr" = "apr",
"may" = "may", "jun" = "jun", "jul" = "jul", "ago" = "aug",
"sept" = "sep", "oct" = "oct", "nov" = "nov", "dic" = "dec"
)
# English month order
month_order <- c("jan", "feb", "mar", "apr", "may", "jun",
"jul", "aug", "sep", "oct", "nov", "dec")
# Summarize by month and species
harvest_summary <- harvest_IFOP_month %>%
mutate(month = recode(month, !!!month_translation)) %>%  # Translate to English
group_by(month, specie) %>%  # Make sure your column is 'species'
summarise(harvest = mean(total_harvest_IFOP_centrosur, na.rm = TRUE),
.groups = "drop") %>%
mutate(month = factor(month, levels = month_order)) %>%
mutate(specie = recode(specie,
"ANCHOVETA" = "Anchoveta",
"SARDINA COMUN" = "Sardine",
"JUREL" = "Jack Mackerel"))
# Plot with facets by species
ggplot(harvest_summary, aes(x = month, y = harvest, fill = specie)) +
geom_bar(stat = "identity") +
facet_wrap(~ specie, scales = "free_y", ncol = 1) +
labs(x = "Month", y = "Average Harvest (tons)", fill = "Specie") +
theme_minimal() +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
scale_fill_brewer(palette = "Paired")
rm(list = c("harvest_IFOP", "harvest_SERNAPESCA", "harvest_IFOP_logbooks"))
library(stringi)
harvest_month_SERNAPESCA <- read.csv(
file.path(dirdata, "SERNAPESCA", "bd_desembarque.csv"),
fileEncoding = "Latin1",
sep = ";") %>%
rename(specie = especie,
year = año,
month = mes) %>%
mutate(zone = case_when(
region %in% c("Valparaíso", "Metropolitana" , "O'Higgins", "Maule", "Ñuble", "Bio-bío", "La Araucanía", "Los Ríos", "Los Lagos") ~ "Centro_Sur",
region %in% c("Arica y Parinacota", "Tarapacá", "Antofagasta", "Atacama", "Coquimbo" ) ~ "Norte",
region %in% c("Magallanes", "Aysén") ~ "Extremo_Sur",
TRUE ~ "No_Especifica")) %>%
mutate(specie = toupper(stri_trans_general(specie, "Latin-ASCII"))) %>%
filter(specie %in% c("ANCHOVETA", "JUREL", "SARDINA COMUN")) %>%
filter(zone %in% c("Centro_Sur"))
# %>%
#   pivot_wider(
#     names_from = zone,
#     values_from = total_harvest_SERNAPESCA_v2,
#     names_glue ="
#   )
# English month order
month_order <- c("jan", "feb", "mar", "apr", "may", "jun",
"jul", "aug", "sep", "oct", "nov", "dec")
harvest_summary2 <- harvest_month_SERNAPESCA %>%
mutate(
month = factor(as.integer(month), levels = 1:12, labels = month_order, ordered = TRUE)
) %>%
group_by(month, year, specie) %>%
summarise(harvestym = sum(toneladas, na.rm = TRUE), .groups = "drop") %>%
filter(year >= 2012) %>%
group_by(month, specie) %>%
summarise(harvest = mean(harvestym, na.rm = TRUE), .groups = "drop") %>%
arrange(month) %>%
mutate(month = factor(month, levels = month_order)) %>%
mutate(specie = recode(specie,
"ANCHOVETA" = "Anchoveta",
"SARDINA COMUN" = "Sardine",
"JUREL" = "Jack Mackerel"))
# Plot with facets by species
ggplot(harvest_summary2, aes(x = month, y = harvest, fill = specie)) +
geom_bar(stat = "identity") +
facet_wrap(~ specie, scales = "free_y", ncol = 1) +
labs(x = "Month", y = "Average Harvest (tons)", fill = "Specie") +
theme_minimal() +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
scale_fill_brewer(palette = "Paired")
rm(list = c("harvest_month_SERNAPESCA"))
library(ggplot2)
library(dplyr)
library(tidyr)
harvest_long <- harvest %>%
dplyr::select(c("specie", "year",
"total_harvest_IFOP_centrosur",
"harvest_LANCHAS_IFOP_centrosur",
"harvest_BOTES_IFOP_centrosur",
"harvest_IND_IFOP_centrosur",
"total_harvest_all_SERNAPESCA_Centro_Sur",
"total_harvest_sernapesca_v2_centro_sur",
"harvest_IFOP_loogbook_centrosur")) %>%
pivot_longer(cols = c("total_harvest_IFOP_centrosur",
"harvest_LANCHAS_IFOP_centrosur",
"harvest_BOTES_IFOP_centrosur",
"harvest_IND_IFOP_centrosur",
"total_harvest_all_SERNAPESCA_Centro_Sur",
"total_harvest_sernapesca_v2_centro_sur",
"harvest_IFOP_loogbook_centrosur"),
names_to = "source",
values_to = "harvest") %>%
mutate(source = recode(source,
"harvest_LANCHAS_IFOP_centrosur" = "Lanchas IFOP",
"harvest_BOTES_IFOP_centrosur" = "Botes IFOP",
"harvest_IND_IFOP_centrosur" = "Industrial IFOP",
"total_harvest_IFOP_centrosur" = "Total IFOP",
"total_harvest_all_SERNAPESCA_Centro_Sur" = "Total SERNAPESCA",
"total_harvest_sernapesca_v2_centro_sur" = "Total SERNAPESCA v2",
"harvest_IFOP_loogbook_centrosur" = "Total IFOP (logbooks)")) %>%
filter(source %in% c("Total IFOP", "Total SERNAPESCA v2", "Total IFOP (logbooks)")) %>% filter(year >= 2012)
# Gráfico
ggplot(harvest_long, aes(x = year, y = harvest, color = source)) +
geom_line(size = 1) +
facet_wrap(~specie, scales = "free_y") +
labs(x = "Anio",
y = "Annual landings (tons)",
color = "Source") +
theme_minimal() +
theme(legend.position = "bottom")
rm(harvest_long)
knitr::include_graphics("figs/env_data_map.pdf")
library(ggplot2)
library(tidyr)
library(scales)
library(viridis)
biomass_long <- biomass %>%
pivot_longer(cols = c(sardine_biomass, anchoveta_biomass, jurel_biomass_cs, jurel_biomass_cs_intra),
names_to = "species",
values_to = "biomass") %>%
filter(!is.na(biomass)) %>%
arrange(species, year)
biomass_long$biomass <- as.numeric(biomass_long$biomass)
biomass_long$year <- as.numeric(biomass_long$year)
biomass_long$species <- recode(biomass_long$species,
sardine_biomass = "Sardine",
anchoveta_biomass = "Anchoveta",
jurel_biomass_cs = "Jack Mackerel",
jurel_biomass_cs_intra = "Jack Mackerel (intrapolated)")
biomass <- biomass_long %>% filter(species %in% c("Sardine", "Anchoveta", "Jack Mackerel", "Jack Mackerel (intrapolated)"))
# Plot
ggplot(biomass, aes(x = year, y = biomass, color = species, group = species)) +
geom_smooth(se = TRUE, method = "loess", span = 0.4, linetype = "solid") +
scale_y_continuous(labels = scales::comma) +  # Or use scale_y_log10(labels = comma) to compress
labs(x = "Year",
y = "Biomass (tons)",
color = "Species") +
theme_minimal() +
theme(
plot.title = element_text(hjust = 0.5),
axis.text.y = element_text(angle = 0, hjust = 1),
legend.position = "right"
) +
scale_color_viridis_d(option = "D")
rm(list = c("biomass_long"))
library(tidyverse)
harvest2 <- harvest %>%
select(c(specie, year, total_harvest_sernapesca_v2_centro_sur)) %>%
mutate(specie = dplyr::recode(specie,
"SARDINA COMUN" = "Sardine",
"JUREL" = "Jack Mackerel",
"ANCHOVETA" = "Anchoveta"
)) %>%
rename(harvest = total_harvest_sernapesca_v2_centro_sur) %>%
rename(species = specie)
harvest2 <- bind_rows(
harvest2,
harvest2 %>%
filter(species == "Jack Mackerel") %>%
mutate(species = "Jack Mackerel (intrapolated)")
)
biomass_harvest <- full_join(biomass, harvest2, by = c("species" = "species", "year" = "year")) %>% arrange(species, year)
biomass_harvest_long <- biomass_harvest %>%
pivot_longer(cols = c(biomass, harvest),
names_to = "variable",
values_to = "value")
ggplot(biomass_harvest_long, aes(x = year, y = value, color = variable)) +
geom_line(size = 1, na.rm = TRUE) +
# geom_point(size = 2, na.rm = TRUE) +
# geom_smooth(se = FALSE, span = 0.4, method = "loess", na.rm = TRUE) + # <- smoothing
facet_wrap(~species, scales = "free_y") +
labs(x = "Year", y = "Value (tons)", color = "Variable") +
scale_color_manual(values = c("biomass" = "darkgreen", "harvest" = "steelblue")) +
theme_minimal() +
theme(legend.position = "top")
library(tidyverse)
library(systemfit)
library(janitor)
# --- 1. Limpieza y preparación de datos ----
biomass_harvest_wide <- biomass_harvest %>%
mutate(species = gsub("[^A-Za-z0-9]", "", tolower(species))) %>%
arrange(species, year) %>%
group_by(species) %>%
mutate(biomass_t1 = lead(biomass)) %>%
ungroup() %>%
pivot_wider(
names_from = species,
values_from = c(biomass, harvest, biomass_t1),
names_sep = "_"
) %>%
janitor::clean_names()
# Biomasa total sin cosecha
biomass_harvest_wide <- biomass_harvest_wide %>%
mutate(
biomass_t1_sardine_noharvest      = biomass_t1_sardine + harvest_sardine,
biomass_t1_anchoveta_noharvest    = biomass_t1_anchoveta + harvest_anchoveta,
biomass_t1_jackmackerel_noharvest = biomass_t1_jackmackerelintrapolated + harvest_jackmackerelintrapolated
)
# Obtener datos ambientales
env_dt_year1 <- env_dt %>%
mutate(year = year(date)) %>%
group_by(year) %>%
summarize(sst = mean(sst, na.rm = TRUE),
chl = mean(chl, na.rm = TRUE),
wind = mean(speed_max, na.rm = TRUE))
env_dt_year2 <- env_dt_00_11 %>%
mutate(year = year(date)) %>%
group_by(year) %>%
summarize(sst = mean(sst, na.rm = TRUE),
chl = mean(chl, na.rm = TRUE),
wind = mean(speed_max, na.rm = TRUE))
env_dt_year <- rbind(env_dt_year2, env_dt_year1)
biomass_harvest_wide <- left_join(biomass_harvest_wide, env_dt_year, by = "year")
View(biomass_harvest_wide)
sur_data <- biomass_harvest_wide %>%
select(
year,
biomass_t1_sardine_noharvest,
biomass_t1_anchoveta_noharvest,
biomass_t1_jackmackerel_noharvest,
biomass_sardine,
biomass_anchoveta,
biomass_jackmackerelintrapolated,
sst, chl
) %>%
drop_na()    # Escalar todo menos año
# --- 3. Definición de ecuaciones ----
eq_sardine <- biomass_t1_sardine_noharvest ~
biomass_sardine +
# biomass_anchoveta +
# biomass_jackmackerelintrapolated +
biomass_sardine:biomass_anchoveta +
biomass_sardine:biomass_jackmackerelintrapolated +
sst + chl
eq_anchoveta <- biomass_t1_anchoveta_noharvest ~
biomass_anchoveta +
# biomass_sardine +
# biomass_jackmackerelintrapolated +
biomass_anchoveta:biomass_sardine +
biomass_anchoveta:biomass_jackmackerelintrapolated  +
sst + chl
eq_jack <- biomass_t1_jackmackerel_noharvest ~
biomass_jackmackerelintrapolated +
# biomass_sardine +
# biomass_anchoveta +
biomass_jackmackerelintrapolated:biomass_sardine +
biomass_jackmackerelintrapolated:biomass_anchoveta  +
sst + chl
# --- 4. Estimación SUR ----
fit_sur <- systemfit(
list(
sardine      = eq_sardine,
anchoveta    = eq_anchoveta
),
data = sur_data,
method = "SUR"
)
eq_sardine <- biomass_t1_sardine_noharvest ~
biomass_sardine +
# biomass_anchoveta +
# biomass_jackmackerelintrapolated +
biomass_sardine:biomass_anchoveta +
biomass_sardine:biomass_jackmackerelintrapolated +
sst
eq_anchoveta <- biomass_t1_anchoveta_noharvest ~
biomass_anchoveta +
# biomass_sardine +
# biomass_jackmackerelintrapolated +
biomass_anchoveta:biomass_sardine +
biomass_anchoveta:biomass_jackmackerelintrapolated  +
sst
eq_jack <- biomass_t1_jackmackerel_noharvest ~
biomass_jackmackerelintrapolated +
# biomass_sardine +
# biomass_anchoveta +
biomass_jackmackerelintrapolated:biomass_sardine +
biomass_jackmackerelintrapolated:biomass_anchoveta  +
sst
# --- 4. Estimación SUR ----
fit_sur <- systemfit(
list(
sardine      = eq_sardine,
anchoveta    = eq_anchoveta
),
data = sur_data,
method = "SUR"
)
View(sur_data)
# --- 2. Subconjunto limpio y escalado ----
sur_data <- biomass_harvest_wide %>%
select(
year,
biomass_t1_sardine_noharvest,
biomass_t1_anchoveta_noharvest,
biomass_t1_jackmackerel_noharvest,
biomass_sardine,
biomass_anchoveta,
biomass_jackmackerelintrapolated,
sst, chl
) %>%
drop_na()    # Escalar todo menos año
# --- 3. Definición de ecuaciones ----
eq_sardine <- biomass_t1_sardine_noharvest ~
biomass_sardine +
# biomass_anchoveta +
# biomass_jackmackerelintrapolated +
biomass_sardine:biomass_anchoveta +
biomass_sardine:biomass_jackmackerelintrapolated +
sst
eq_anchoveta <- biomass_t1_anchoveta_noharvest ~
biomass_anchoveta +
# biomass_sardine +
# biomass_jackmackerelintrapolated +
biomass_anchoveta:biomass_sardine +
biomass_anchoveta:biomass_jackmackerelintrapolated  +
sst
eq_jack <- biomass_t1_jackmackerel_noharvest ~
biomass_jackmackerelintrapolated +
# biomass_sardine +
# biomass_anchoveta +
biomass_jackmackerelintrapolated:biomass_sardine +
biomass_jackmackerelintrapolated:biomass_anchoveta  +
sst
# --- 4. Estimación SUR ----
fit_sur <- systemfit(
list(
sardine      = eq_sardine,
anchoveta    = eq_anchoveta
),
data = sur_data,
method = "SUR"
)
# --- 1) Datos base
sur_data <- biomass_harvest_wide %>%
select(
year,
biomass_t1_sardine_noharvest,
biomass_t1_anchoveta_noharvest,
biomass_t1_jackmackerel_noharvest,
biomass_sardine,
biomass_anchoveta,
biomass_jackmackerelintrapolated,
sst, chl, wind
) %>%
drop_na()
# --- 2) Centrar (no escalar) todo excepto 'year' ---
sur_center <- sur_data %>%
mutate(across(where(is.numeric) & !matches("^year$"),
~ .x - mean(.x, na.rm = TRUE)))
# --- 3) Ecuaciones con jerarquía (si hay x:y, incluye x y y) ---
eq_sardine <- biomass_t1_sardine_noharvest ~
biomass_sardine + biomass_anchoveta + biomass_jackmackerelintrapolated +
sst + chl + wind +
biomass_sardine:biomass_anchoveta +
biomass_sardine:biomass_jackmackerelintrapolated
eq_anchoveta <- biomass_t1_anchoveta_noharvest ~
biomass_anchoveta + biomass_sardine + biomass_jackmackerelintrapolated +
sst + chl + wind +
biomass_anchoveta:biomass_sardine +
biomass_anchoveta:biomass_jackmackerelintrapolated
# Si quieres agregar jurel como tercera ecuación, hazlo después de verificar estabilidad
# eq_jack <- biomass_t1_jackmackerel_noharvest ~
#   biomass_jackmackerelintrapolated + biomass_sardine + biomass_anchoveta +
#   sst + chl + wind +
#   biomass_jackmackerelintrapolated:biomass_sardine +
#   biomass_jackmackerelintrapolated:biomass_anchoveta
# --- 4) Estimación SUR ---
fit_sur <- systemfit(
list(
sardine   = eq_sardine,
anchoveta = eq_anchoveta
# , jackmackerel = eq_jack
),
data = sur_center,
method = "SUR"
)
sur_scaled <- biomass_harvest_wide %>%
select(
year,
biomass_t1_sardine_noharvest,
biomass_t1_anchoveta_noharvest,
biomass_t1_jackmackerel_noharvest,
biomass_sardine,
biomass_anchoveta,
biomass_jackmackerelintrapolated,
sst, chl, wind
) %>%
drop_na() %>%
mutate(across(where(is.numeric) & !matches("^year$"), scale))
View(sur_scaled)
eq_sardine_sc <- biomass_t1_sardine_noharvest ~
biomass_sardine + biomass_anchoveta + biomass_jackmackerelintrapolated +
sst + chl + wind +
biomass_sardine:biomass_anchoveta +
biomass_sardine:biomass_jackmackerelintrapolated
eq_anchoveta_sc <- biomass_t1_anchoveta_noharvest ~
biomass_anchoveta + biomass_sardine + biomass_jackmackerelintrapolated +
sst + chl + wind +
biomass_anchoveta:biomass_sardine +
biomass_anchoveta:biomass_jackmackerelintrapolated
fit_sur_sc <- systemfit(
list(
sardine   = eq_sardine_sc,
anchoveta = eq_anchoveta_sc
),
data = sur_scaled,
method = "SUR"
)
summary(fit_sur_sc)
sur_scaled <- biomass_harvest_wide %>%
select(
year,
biomass_t1_sardine_noharvest,
biomass_t1_anchoveta_noharvest,
biomass_t1_jackmackerel_noharvest,
biomass_sardine,
biomass_anchoveta,
biomass_jackmackerelintrapolated,
sst, chl, wind
) %>%
drop_na() %>%
mutate(across(where(is.numeric) & !matches("^year$"), scale))
eq_sardine_sc <- biomass_t1_sardine_noharvest ~
biomass_sardine + biomass_anchoveta + biomass_jackmackerelintrapolated +
sst + chl +
biomass_sardine:biomass_anchoveta +
biomass_sardine:biomass_jackmackerelintrapolated
eq_anchoveta_sc <- biomass_t1_anchoveta_noharvest ~
biomass_anchoveta + biomass_sardine + biomass_jackmackerelintrapolated +
sst + chl +
biomass_anchoveta:biomass_sardine +
biomass_anchoveta:biomass_jackmackerelintrapolated
fit_sur_sc <- systemfit(
list(
sardine   = eq_sardine_sc,
anchoveta = eq_anchoveta_sc
),
data = sur_scaled,
method = "SUR"
)
summary(fit_sur_sc)
eq_jackmackerel_sc <- biomass_t1_jackmackerel_noharvest ~
biomass_anchoveta + biomass_sardine + biomass_jackmackerelintrapolated +
sst + chl +
biomass_jackmackerel:biomass_sardine +
biomass_jackmackerel:biomass_anchoveta
fit_sur_sc <- systemfit(
list(
sardine   = eq_sardine_sc,
anchoveta = eq_anchoveta_sc,
jackmackerel = eq_jackmackerel_sc
),
data = sur_scaled,
method = "SUR"
)
eq_jackmackerel_sc <- biomass_t1_jackmackerel_noharvest ~
biomass_anchoveta + biomass_sardine + biomass_jackmackerelintrapolated +
sst + chl +
biomass_jackmackerelintrapolated:biomass_sardine +
biomass_jackmackerelintrapolated:biomass_anchoveta
fit_sur_sc <- systemfit(
list(
sardine   = eq_sardine_sc,
anchoveta = eq_anchoveta_sc,
jackmackerel = eq_jackmackerel_sc
),
data = sur_scaled,
method = "SUR"
)
summary(fit_sur_sc)
eq_sardine_sc <- biomass_t1_sardine_noharvest ~
biomass_sardine + biomass_anchoveta + biomass_jackmackerelintrapolated +
sst + chl + wind +
biomass_sardine:biomass_anchoveta +
biomass_sardine:biomass_jackmackerelintrapolated
eq_anchoveta_sc <- biomass_t1_anchoveta_noharvest ~
biomass_anchoveta + biomass_sardine + biomass_jackmackerelintrapolated +
sst + chl + wind +
biomass_anchoveta:biomass_sardine +
biomass_anchoveta:biomass_jackmackerelintrapolated
eq_jackmackerel_sc <- biomass_t1_jackmackerel_noharvest ~
biomass_anchoveta + biomass_sardine + biomass_jackmackerelintrapolated +
sst + chl + wind +
biomass_jackmackerelintrapolated:biomass_sardine +
biomass_jackmackerelintrapolated:biomass_anchoveta
fit_sur_sc <- systemfit(
list(
sardine   = eq_sardine_sc,
anchoveta = eq_anchoveta_sc,
jackmackerel = eq_jackmackerel_sc
),
data = sur_scaled,
method = "SUR"
)
summary(fit_sur_sc)
knitr::include_graphics("figs/env_data_map.pdf")
knitr::include_graphics("figs/env_data_map.pdf")
