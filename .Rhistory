)
# %>%
#   filter(strategy_Before_simple %in% c("Sardine", "Anchoveta", "Sardine & Anchoveta", "Sardine & JackMackerel", "JackMackerel & Anchoveta", "Sardine, JackMackerel & Anchoveta","No fishing") |
#            strategy_After_simple %in% c("Sardine", "Anchoveta", "Sardine & Anchoveta", "Sardine & JackMackerel", "JackMackerel & Anchoveta", "Sardine, JackMackerel & Anchoveta","No fishing"))# %>%
#   filter(strategy_Before_simple %in% c("Sardine", "Anchoveta", "Sardine & Anchoveta", "Sardine & JackMackerel", "JackMackerel & Anchoveta", "Sardine, JackMackerel & Anchoveta","No fishing") |
#            strategy_After_simple %in% c("Sardine", "Anchoveta", "Sardine & Anchoveta", "Sardine & JackMackerel", "JackMackerel & Anchoveta", "Sardine, JackMackerel & Anchoveta","No fishing"))
transition_counts_focus <- strategy_transitions_focus %>%
count(strategy_Before_simple, strategy_After_simple)
# Base plot
p <- ggplot(transition_counts_focus,
aes(axis1 = strategy_Before_simple,
axis2 = strategy_After_simple,
y = n)) +
geom_flow(aes(fill = strategy_Before_simple),
width = 1/12, knot.pos = 0.4, alpha = 0.8) +
geom_stratum(width = 1/12, fill = "gray95", color = "black") +
scale_x_discrete(limits = c("2012–2018", "2019–2024"),
expand = c(.25, .25)) +
scale_fill_brewer(type = "qual", palette = "Set2") +
labs(x = "", y = "Number of Vessels") +
theme_minimal(base_size = 12) +
theme(
legend.position = "none",
panel.grid = element_blank()
)
# Extraer posiciones de etiquetas
stratum_data <- ggplot_build(p)$data[[2]]
left_labels <- stratum_data %>%
filter(x == 1) %>%
mutate(x = x - 0.05,
stratum = str_wrap(stratum, width = 20))
right_labels <- stratum_data %>%
filter(x == 2) %>%
mutate(x = x + 0.05,
stratum = str_wrap(stratum, width = 20))
# Agregar etiquetas con repel
p +
geom_text_repel(
data = left_labels,
aes(x = x, y = y, label = stratum),
inherit.aes = FALSE,
hjust = 1, nudge_x = -0.1, direction = "y",
size = 2.5, segment.color = "grey60", segment.size = 0.3
) +
geom_text_repel(
data = right_labels,
aes(x = x, y = y, label = stratum),
inherit.aes = FALSE,
hjust = 0, nudge_x = 0.1, direction = "y",
size = 2.5, segment.color = "grey60", segment.size = 0.3
)
library(readxl)
library(dplyr)
harvest_IFOP_month <- readRDS("data/harvest/IFOP_month.rds")
harvest_IFOP <- readRDS("data/harvest/IFOP.rds")
harvest_SERNAPESCA <- readRDS("data/harvest/sernapesca.rds")
harvest_SERNAPESCA_v2 <- readRDS("data/harvest/sernapesca_v2.rds")
#---- IFOP loogbook data ----
harvest_IFOP_logbooks <- logbooks %>%
filter(year >= 2012) %>%
filter(REGION %in% c(5,6,7,8,9,10,14,16)) %>%
group_by(NOMBRE_ESPECIE, year) %>%
summarise(
harvest_IFOP_loogbook_centrosur = sum(CAPTURA_RETENIDA, na.rm = TRUE),
.groups = "drop"
) %>%
rename(specie = NOMBRE_ESPECIE) %>%
mutate(harvest_IFOP_loogbook_centrosur = harvest_IFOP_loogbook_centrosur / 1000)
#---- Harvest data merged ----
harvest <- left_join(harvest_SERNAPESCA_v2, harvest_SERNAPESCA, by = c("year", "specie"))
harvest <- left_join(harvest, harvest_IFOP, by = c("year", "specie"))
harvest <- left_join(harvest, harvest_IFOP_logbooks, by = c("year", "specie"))
# Spanish to English month translation
month_translation <- c(
"ene" = "jan", "feb" = "feb", "mar" = "mar", "abr" = "apr",
"may" = "may", "jun" = "jun", "jul" = "jul", "ago" = "aug",
"sept" = "sep", "oct" = "oct", "nov" = "nov", "dic" = "dec"
)
# English month order
month_order <- c("jan", "feb", "mar", "apr", "may", "jun",
"jul", "aug", "sep", "oct", "nov", "dec")
# Summarize by month and species
harvest_summary <- harvest_IFOP_month %>%
mutate(month = recode(month, !!!month_translation)) %>%  # Translate to English
group_by(month, specie) %>%  # Make sure your column is 'species'
summarise(harvest = mean(total_harvest_IFOP_centrosur, na.rm = TRUE),
.groups = "drop") %>%
mutate(month = factor(month, levels = month_order)) %>%
mutate(specie = recode(specie,
"ANCHOVETA" = "Anchoveta",
"SARDINA COMUN" = "Sardine",
"JUREL" = "Jack Mackerel"))
# Plot with facets by species
ggplot(harvest_summary, aes(x = month, y = harvest, fill = specie)) +
geom_bar(stat = "identity") +
facet_wrap(~ specie, scales = "free_y", ncol = 1) +
labs(x = "Month", y = "Average Harvest (tons)", fill = "Specie") +
theme_minimal() +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
scale_fill_brewer(palette = "Paired")
rm(list = c("harvest_IFOP", "harvest_SERNAPESCA", "harvest_IFOP_logbooks"))
library(stringi)
harvest_month_SERNAPESCA <- read.csv(
file.path(dirdata, "SERNAPESCA", "bd_desembarque.csv"),
fileEncoding = "Latin1",
sep = ";") %>%
rename(specie = especie,
year = año,
month = mes) %>%
library(ggplot2)
library(dplyr)
library(tidyr)
harvest_long <- harvest %>%
dplyr::select(c("specie", "year",
"total_harvest_IFOP_centrosur",
"harvest_LANCHAS_IFOP_centrosur",
"harvest_BOTES_IFOP_centrosur",
"harvest_IND_IFOP_centrosur",
"total_harvest_all_SERNAPESCA_Centro_Sur",
"total_harvest_sernapesca_v2_centro_sur",
"harvest_IFOP_loogbook_centrosur")) %>%
pivot_longer(cols = c("total_harvest_IFOP_centrosur",
"harvest_LANCHAS_IFOP_centrosur",
"harvest_BOTES_IFOP_centrosur",
"harvest_IND_IFOP_centrosur",
"total_harvest_all_SERNAPESCA_Centro_Sur",
"total_harvest_sernapesca_v2_centro_sur",
"harvest_IFOP_loogbook_centrosur"),
names_to = "source",
values_to = "harvest") %>%
mutate(source = recode(source,
"harvest_LANCHAS_IFOP_centrosur" = "Lanchas IFOP",
"harvest_BOTES_IFOP_centrosur" = "Botes IFOP",
"harvest_IND_IFOP_centrosur" = "Industrial IFOP",
"total_harvest_IFOP_centrosur" = "Total IFOP",
"total_harvest_all_SERNAPESCA_Centro_Sur" = "Total SERNAPESCA",
"total_harvest_sernapesca_v2_centro_sur" = "Total SERNAPESCA v2",
"harvest_IFOP_loogbook_centrosur" = "Total IFOP (logbooks)")) %>%
filter(source %in% c("Total IFOP", "Total SERNAPESCA", "Total SERNAPESCA v2",
"Total IFOP (logbooks)", "Lanchas IFOP", "Botes IFOP",
"Industrial IFOP")) %>% filter(year >= 2012)
# Gráfico
ggplot(harvest_long, aes(x = year, y = harvest, color = source)) +
geom_line(size = 1) +
facet_wrap(~specie, scales = "free_y") +
labs(x = "Año",
y = "Annual landings (tons)",
library(ggplot2)
library(dplyr)
library(tidyr)
harvest_long <- harvest %>%
dplyr::select(c("specie", "year",
"total_harvest_IFOP_centrosur",
"harvest_LANCHAS_IFOP_centrosur",
"harvest_BOTES_IFOP_centrosur",
"harvest_IND_IFOP_centrosur",
"total_harvest_all_SERNAPESCA_Centro_Sur",
"total_harvest_sernapesca_v2_centro_sur",
"harvest_IFOP_loogbook_centrosur")) %>%
pivot_longer(cols = c("total_harvest_IFOP_centrosur",
"harvest_LANCHAS_IFOP_centrosur",
"harvest_BOTES_IFOP_centrosur",
"harvest_IND_IFOP_centrosur",
"total_harvest_all_SERNAPESCA_Centro_Sur",
"total_harvest_sernapesca_v2_centro_sur",
"harvest_IFOP_loogbook_centrosur"),
names_to = "source",
values_to = "harvest") %>%
mutate(source = recode(source,
"harvest_LANCHAS_IFOP_centrosur" = "Lanchas IFOP",
"harvest_BOTES_IFOP_centrosur" = "Botes IFOP",
"harvest_IND_IFOP_centrosur" = "Industrial IFOP",
"total_harvest_IFOP_centrosur" = "Total IFOP",
"total_harvest_all_SERNAPESCA_Centro_Sur" = "Total SERNAPESCA",
"total_harvest_sernapesca_v2_centro_sur" = "Total SERNAPESCA v2",
"harvest_IFOP_loogbook_centrosur" = "Total IFOP (logbooks)")) %>%
filter(source %in% c("Total IFOP", "Total SERNAPESCA", "Total SERNAPESCA v2",
"Total IFOP (logbooks)", "Lanchas IFOP", "Botes IFOP",
"Industrial IFOP")) %>% filter(year >= 2012)
# Gráfico
ggplot(harvest_long, aes(x = year, y = harvest, color = source)) +
geom_line(size = 1) +
facet_wrap(~specie, scales = "free_y") +
labs(x = "Anio",
y = "Annual landings (tons)",
color = "Source") +
theme_minimal() +
theme(legend.position = "bottom")
rm(harvest_long)
library(ggplot2)
library(dplyr)
library(tidyr)
harvest_long <- harvest %>%
dplyr::select(c("specie", "year",
"total_harvest_IFOP_centrosur",
"harvest_LANCHAS_IFOP_centrosur",
"harvest_BOTES_IFOP_centrosur",
"harvest_IND_IFOP_centrosur",
"total_harvest_all_SERNAPESCA_Centro_Sur",
"total_harvest_sernapesca_v2_centro_sur",
"harvest_IFOP_loogbook_centrosur")) %>%
pivot_longer(cols = c("total_harvest_IFOP_centrosur",
"harvest_LANCHAS_IFOP_centrosur",
"harvest_BOTES_IFOP_centrosur",
"harvest_IND_IFOP_centrosur",
"total_harvest_all_SERNAPESCA_Centro_Sur",
"total_harvest_sernapesca_v2_centro_sur",
"harvest_IFOP_loogbook_centrosur"),
names_to = "source",
values_to = "harvest") %>%
mutate(source = recode(source,
"harvest_LANCHAS_IFOP_centrosur" = "Lanchas IFOP",
"harvest_BOTES_IFOP_centrosur" = "Botes IFOP",
"harvest_IND_IFOP_centrosur" = "Industrial IFOP",
"total_harvest_IFOP_centrosur" = "Total IFOP",
"total_harvest_all_SERNAPESCA_Centro_Sur" = "Total SERNAPESCA",
"total_harvest_sernapesca_v2_centro_sur" = "Total SERNAPESCA v2",
"harvest_IFOP_loogbook_centrosur" = "Total IFOP (logbooks)")) %>%
filter(source %in% c("Total IFOP", "Total SERNAPESCA v2",
"Total IFOP (logbooks)", "Lanchas IFOP", "Botes IFOP",
"Industrial IFOP")) %>% filter(year >= 2012)
# Gráfico
ggplot(harvest_long, aes(x = year, y = harvest, color = source)) +
geom_line(size = 1) +
facet_wrap(~specie, scales = "free_y") +
labs(x = "Anio",
y = "Annual landings (tons)",
color = "Source") +
theme_minimal() +
theme(legend.position = "bottom")
rm(harvest_long)
library(ggplot2)
library(dplyr)
library(tidyr)
harvest_long <- harvest %>%
dplyr::select(c("specie", "year",
"total_harvest_IFOP_centrosur",
"harvest_LANCHAS_IFOP_centrosur",
"harvest_BOTES_IFOP_centrosur",
"harvest_IND_IFOP_centrosur",
"total_harvest_all_SERNAPESCA_Centro_Sur",
"total_harvest_sernapesca_v2_centro_sur",
"harvest_IFOP_loogbook_centrosur")) %>%
pivot_longer(cols = c("total_harvest_IFOP_centrosur",
"harvest_LANCHAS_IFOP_centrosur",
"harvest_BOTES_IFOP_centrosur",
"harvest_IND_IFOP_centrosur",
"total_harvest_all_SERNAPESCA_Centro_Sur",
"total_harvest_sernapesca_v2_centro_sur",
"harvest_IFOP_loogbook_centrosur"),
names_to = "source",
values_to = "harvest") %>%
mutate(source = recode(source,
"harvest_LANCHAS_IFOP_centrosur" = "Lanchas IFOP",
"harvest_BOTES_IFOP_centrosur" = "Botes IFOP",
"harvest_IND_IFOP_centrosur" = "Industrial IFOP",
"total_harvest_IFOP_centrosur" = "Total IFOP",
"total_harvest_all_SERNAPESCA_Centro_Sur" = "Total SERNAPESCA",
"total_harvest_sernapesca_v2_centro_sur" = "Total SERNAPESCA v2",
"harvest_IFOP_loogbook_centrosur" = "Total IFOP (logbooks)")) %>%
filter(source %in% c("Total IFOP", "Total SERNAPESCA v2",
"Total IFOP (logbooks)",
"Industrial IFOP")) %>% filter(year >= 2012)
# Gráfico
ggplot(harvest_long, aes(x = year, y = harvest, color = source)) +
geom_line(size = 1) +
facet_wrap(~specie, scales = "free_y") +
labs(x = "Anio",
y = "Annual landings (tons)",
color = "Source") +
theme_minimal() +
theme(legend.position = "bottom")
rm(harvest_long)
library(ggplot2)
library(dplyr)
library(tidyr)
harvest_long <- harvest %>%
dplyr::select(c("specie", "year",
"total_harvest_IFOP_centrosur",
"harvest_LANCHAS_IFOP_centrosur",
"harvest_BOTES_IFOP_centrosur",
"harvest_IND_IFOP_centrosur",
"total_harvest_all_SERNAPESCA_Centro_Sur",
"total_harvest_sernapesca_v2_centro_sur",
"harvest_IFOP_loogbook_centrosur")) %>%
pivot_longer(cols = c("total_harvest_IFOP_centrosur",
"harvest_LANCHAS_IFOP_centrosur",
"harvest_BOTES_IFOP_centrosur",
"harvest_IND_IFOP_centrosur",
"total_harvest_all_SERNAPESCA_Centro_Sur",
"total_harvest_sernapesca_v2_centro_sur",
"harvest_IFOP_loogbook_centrosur"),
names_to = "source",
values_to = "harvest") %>%
mutate(source = recode(source,
"harvest_LANCHAS_IFOP_centrosur" = "Lanchas IFOP",
"harvest_BOTES_IFOP_centrosur" = "Botes IFOP",
"harvest_IND_IFOP_centrosur" = "Industrial IFOP",
"total_harvest_IFOP_centrosur" = "Total IFOP",
"total_harvest_all_SERNAPESCA_Centro_Sur" = "Total SERNAPESCA",
"total_harvest_sernapesca_v2_centro_sur" = "Total SERNAPESCA v2",
"harvest_IFOP_loogbook_centrosur" = "Total IFOP (logbooks)")) %>%
filter(source %in% c("Total IFOP", "Total SERNAPESCA v2", "Total IFOP (logbooks)")) %>% filter(year >= 2012)
# Gráfico
ggplot(harvest_long, aes(x = year, y = harvest, color = source)) +
geom_line(size = 1) +
facet_wrap(~specie, scales = "free_y") +
labs(x = "Anio",
y = "Annual landings (tons)",
color = "Source") +
theme_minimal() +
theme(legend.position = "bottom")
rm(harvest_long)
library(ggplot2)
library(tidyr)
library(scales)
library(viridis)
biomass_long <- biomass %>%
pivot_longer(cols = c(sardine_biomass, anchoveta_biomass, jurel_biomass_cs, jurel_biomass_cs_intra),
names_to = "species",
values_to = "biomass") %>%
filter(!is.na(biomass)) %>%
arrange(species, year)
biomass_long$biomass <- as.numeric(biomass_long$biomass)
biomass_long$year <- as.numeric(biomass_long$year)
biomass_long$species <- recode(biomass_long$species,
sardine_biomass = "Sardine",
anchoveta_biomass = "Anchoveta",
jurel_biomass_cs = "Jack Mackerel",
jurel_biomass_cs_intra = "Jack Mackerel (intrapolated)")
biomass <- biomass_long %>% filter(species %in% c("Sardine", "Anchoveta", "Jack Mackerel", "Jack Mackerel (intrapolated)"))
# Plot
ggplot(biomass, aes(x = year, y = biomass, color = species, group = species)) +
geom_smooth(se = TRUE, method = "loess", span = 0.4, linetype = "solid") +
scale_y_continuous(labels = scales::comma) +  # Or use scale_y_log10(labels = comma) to compress
labs(x = "Year",
y = "Biomass (tons)",
color = "Species") +
theme_minimal() +
theme(
plot.title = element_text(hjust = 0.5),
axis.text.y = element_text(angle = 0, hjust = 1),
legend.position = "right"
) +
scale_color_viridis_d(option = "D")
rm(list = c("biomass_long"))
View(harvest)
library(tidyverse)
harvest2 <- harvest %>%
select(c(specie, year, total_harvest_sernapesca_v2_centrosur)) %>%
mutate(specie = recode(specie,
"SARDINA COMUN" = "Sardine",
"JUREL" = "Jack Mackerel",
"ANCHOVETA" = "Anchoveta"
)) %>%
rename(harvest = total_harvest_sernapesca_v2_centrosur) %>%
rename(species = specie)
library(tidyverse)
harvest2 <- harvest %>%
select(c(specie, year, total_harvest_sernapesca_v2_centrosur)) %>%
mutate(specie = recode(specie,
"SARDINA COMUN" = "Sardine",
"JUREL" = "Jack Mackerel",
"ANCHOVETA" = "Anchoveta"
)) %>%
rename(harvest = total_harvest_sernapesca_v2_centrosur) %>%
rename(species = specie)
library(tidyverse)
harvest2 <- harvest %>%
select(c(specie, year, total_harvest_sernapesca_v2_centro_sur)) %>%
mutate(specie = recode(specie,
"SARDINA COMUN" = "Sardine",
"JUREL" = "Jack Mackerel",
"ANCHOVETA" = "Anchoveta"
)) %>%
rename(harvest = total_harvest_sernapesca_v2_centro_sur) %>%
rename(species = specie)
harvest2 <- bind_rows(
harvest2,
harvest2 %>%
filter(species == "Jack Mackerel") %>%
mutate(species = "Jack Mackerel (intrapolated)")
)
biomass_harvest <- full_join(biomass, harvest2, by = c("species" = "species", "year" = "year")) %>% arrange(species, year)
biomass_harvest_long <- biomass_harvest %>%
pivot_longer(cols = c(biomass, harvest),
names_to = "variable",
values_to = "value")
ggplot(biomass_harvest_long, aes(x = year, y = value, color = variable)) +
# geom_line(size = 1, na.rm = TRUE) +
# geom_point(size = 2, na.rm = TRUE) +
geom_smooth(se = FALSE, span = 0.4, method = "loess", na.rm = TRUE) + # <- smoothing
facet_wrap(~species, scales = "free_y") +
labs(x = "Year", y = "Value (tons)", color = "Variable") +
scale_color_manual(values = c("biomass" = "darkgreen", "harvest" = "steelblue")) +
theme_minimal() +
theme(legend.position = "top")
library(tidyverse)
harvest2 <- harvest %>%
select(c(specie, year, total_harvest_sernapesca_v2_centro_sur)) %>%
mutate(specie = recode(specie,
"SARDINA COMUN" = "Sardine",
"JUREL" = "Jack Mackerel",
"ANCHOVETA" = "Anchoveta"
)) %>%
rename(harvest = total_harvest_sernapesca_v2_centro_sur) %>%
rename(species = specie)
harvest2 <- bind_rows(
harvest2,
harvest2 %>%
filter(species == "Jack Mackerel") %>%
mutate(species = "Jack Mackerel (intrapolated)")
)
biomass_harvest <- full_join(biomass, harvest2, by = c("species" = "species", "year" = "year")) %>% arrange(species, year)
biomass_harvest_long <- biomass_harvest %>%
pivot_longer(cols = c(biomass, harvest),
names_to = "variable",
values_to = "value")
ggplot(biomass_harvest_long, aes(x = year, y = value, color = variable)) +
geom_line(size = 1, na.rm = TRUE) +
geom_point(size = 2, na.rm = TRUE) +
# geom_smooth(se = FALSE, span = 0.4, method = "loess", na.rm = TRUE) + # <- smoothing
facet_wrap(~species, scales = "free_y") +
labs(x = "Year", y = "Value (tons)", color = "Variable") +
scale_color_manual(values = c("biomass" = "darkgreen", "harvest" = "steelblue")) +
theme_minimal() +
theme(legend.position = "top")
library(tidyverse)
harvest2 <- harvest %>%
select(c(specie, year, total_harvest_sernapesca_v2_centro_sur)) %>%
mutate(specie = recode(specie,
"SARDINA COMUN" = "Sardine",
"JUREL" = "Jack Mackerel",
"ANCHOVETA" = "Anchoveta"
)) %>%
rename(harvest = total_harvest_sernapesca_v2_centro_sur) %>%
rename(species = specie)
harvest2 <- bind_rows(
harvest2,
harvest2 %>%
filter(species == "Jack Mackerel") %>%
mutate(species = "Jack Mackerel (intrapolated)")
)
biomass_harvest <- full_join(biomass, harvest2, by = c("species" = "species", "year" = "year")) %>% arrange(species, year)
biomass_harvest_long <- biomass_harvest %>%
pivot_longer(cols = c(biomass, harvest),
names_to = "variable",
values_to = "value")
ggplot(biomass_harvest_long, aes(x = year, y = value, color = variable)) +
geom_line(size = 1, na.rm = TRUE) +
# geom_point(size = 2, na.rm = TRUE) +
# geom_smooth(se = FALSE, span = 0.4, method = "loess", na.rm = TRUE) + # <- smoothing
facet_wrap(~species, scales = "free_y") +
labs(x = "Year", y = "Value (tons)", color = "Variable") +
scale_color_manual(values = c("biomass" = "darkgreen", "harvest" = "steelblue")) +
theme_minimal() +
theme(legend.position = "top")
View(biomass_harvest)
# Load packages
library(tidyverse)
library(dplyr)
library(tidyr)
library(janitor) # for clean_names() if needed
library(systemfit)
library(lmtest)
library(sandwich)
biomass_harvest_wide <- biomass_harvest %>%
mutate(species = gsub("[^A-Za-z0-9]", "", tolower(species))) %>%
arrange(species, year) %>%
group_by(species) %>%
mutate(biomass_t1 = lead(biomass)) %>%  # biomass in t+1 within each species
ungroup() %>%
pivot_wider(
names_from = species,
values_from = c(biomass, harvest, biomass_t1),
names_sep = "_"
) %>%
janitor::clean_names()
biomass_harvest_wide <- biomass_harvest_wide %>%
mutate(biomass_t1_sardine_noharvest = biomass_t1_sardine + harvest_sardine) %>%
mutate(biomass_t1_anchoveta_noharvest = biomass_t1_anchoveta + harvest_anchoveta)
## 1) Deja solo casos completos de TODAS las variables usadas por las 2 ecuaciones
sur_data <- biomass_harvest_wide %>%
select(biomass_t1_sardine_noharvest, biomass_t1_anchoveta_noharvest,
biomass_sardine, biomass_anchoveta) %>%
tidyr::drop_na()
## 2) Define y estima el SUR sobre ese subconjunto limpio
eq1 <- biomass_t1_sardine_noharvest  ~ biomass_sardine + biomass_anchoveta
eq2 <- biomass_t1_anchoveta_noharvest ~ biomass_anchoveta + biomass_sardine
fit_sur <- systemfit(list(sardine = eq1, anchoveta = eq2), data = sur_data, method = "SUR")
summary(fit_sur)
## 3) Matrices de diseño por ecuación (con las MISMAS filas que usó el SUR)
X1 <- model.matrix(eq1, data = sur_data)
X2 <- model.matrix(eq2, data = sur_data)
## 4) Bloque diagonal de X y vector de residuos apilado
X_blk <- as.matrix(bdiag(X1, X2))
u1 <- residuals(fit_sur)$sardine
u2 <- residuals(fit_sur)$anchoveta
u  <- c(u1, u2)
## 5) Sandwich White a nivel del sistema
# bread = (X'X)^(-1) ; meat = X' diag(u^2) X
bread <- solve(crossprod(X_blk))
Omega <- Diagonal(x = as.numeric(u^2))
meat  <- crossprod(X_blk, Omega %*% X_blk)
vcov_white <- bread %*% meat %*% bread
## 6) Tabla con EE robustos, z y p-valor
b     <- coef(fit_sur)
seR   <- sqrt(diag(vcov_white))
zval  <- b / seR
pval  <- 2 * pnorm(abs(zval), lower.tail = FALSE)
robust_table <- cbind(Estimate = b, `Robust SE` = seR, `z value` = zval, `Pr(>|z|)` = pval)
round(robust_table, 4)
