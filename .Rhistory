lm_jack <- patch_lm_with_lavaan(lm_jack, eq_jack)
## 5. Construir vectores de SE robustas (MLR) para cada eq ------
make_se_vec <- function(lm_obj, eq_obj) {
# SE de slopes
se_beta    <- eq_obj$reg$se
names(se_beta) <- eq_obj$reg$rhs
# SE de intercepto
se_beta0      <- eq_obj$int$se
names(se_beta0) <- "(Intercept)"
se_full <- rep(NA_real_, length(coef(lm_obj)))
names(se_full) <- names(coef(lm_obj))
se_full["(Intercept)"] <- se_beta0
se_full[names(se_beta)] <- se_beta
se_full
}
se_sard <- make_se_vec(lm_sard, eq_sard)
se_anch <- make_se_vec(lm_anch, eq_anch)
se_jack <- make_se_vec(lm_jack, eq_jack)
## 6. Tabla en LaTeX con stargazer -----------------------------
stargazer(
lm_sard, lm_anch, lm_jack,
type = "latex",                       # c√°mbialo a "text" para ver en consola
title = "Sistema SUR estimado con lavaan (MLR, errores robustos)",
label = "tab:sur_lavaan_robust",
column.labels = c("Sardina", "Anchoveta", "Jurel"),
dep.var.labels = c("Biomasa t+1"),
dep.var.caption = "",
se = list(se_sard, se_anch, se_jack), # << aqu√≠ van las SE de lavaan
omit.stat = c("f"),                   # deja N, R2, Adj.R2
digits = 3,
float.env = "table",
no.space = TRUE,
single.row = TRUE
)
library(lavaan)
library(dplyr)
library(stargazer)
## 1. Extraer par√°metros de lavaan -----------------------------
pe <- parameterEstimates(fit_sem, standardized = FALSE)
# Regresiones (slopes)
pe_reg <- pe %>%
filter(op == "~")
# Interceptos
pe_int <- pe %>%
filter(op == "~1")
# Funci√≥n auxiliar: extraer info por ecuaci√≥n
get_eq <- function(yname) {
list(
reg = pe_reg %>% filter(lhs == yname),
int = pe_int %>% filter(lhs == yname)
)
}
eq_sard <- get_eq("biomass_t1_sardine_noharvest")
eq_anch <- get_eq("biomass_t1_anchoveta_noharvest")
eq_jack <- get_eq("biomass_t1_jackmackerel_noharvest")
## 2. Construir f√≥rmulas lm para cada ecuaci√≥n -----------------
make_formula <- function(dep, eq_obj) {
rhs <- paste(eq_obj$reg$rhs, collapse = " + ")
as.formula(paste(dep, "~", rhs))
}
form_sard <- make_formula("biomass_t1_sardine_noharvest",      eq_sard)
form_anch <- make_formula("biomass_t1_anchoveta_noharvest",    eq_anch)
form_jack <- make_formula("biomass_t1_jackmackerel_noharvest", eq_jack)
## 3. Ajustar lm ‚Äúreales‚Äù (pero despu√©s los parchamos) ---------
lm_sard <- lm(form_sard, data = sur_df)
lm_anch <- lm(form_anch, data = sur_df)
lm_jack <- lm(form_jack, data = sur_df)
## 4. Reemplazar coeficientes de lm por los de lavaan ----------
patch_lm_with_lavaan <- function(lm_obj, eq_obj) {
# coeficientes de lavaan
beta <- eq_obj$reg$est
names(beta) <- eq_obj$reg$rhs
# intercepto
beta0 <- eq_obj$int$est
names(beta0) <- "(Intercept)"
# vector completo
beta_full <- lm_obj$coefficients
beta_full["(Intercept)"] <- beta0
beta_full[names(beta)] <- beta
# ‚úî reemplazo correcto
lm_obj$coefficients <- beta_full
return(lm_obj)
}
lm_sard <- patch_lm_with_lavaan(lm_sard, eq_sard)
lm_anch <- patch_lm_with_lavaan(lm_anch, eq_anch)
lm_jack <- patch_lm_with_lavaan(lm_jack, eq_jack)
## 5. Construir vectores de SE robustas (MLR) para cada eq ------
make_se_vec <- function(lm_obj, eq_obj) {
# SE de slopes
se_beta    <- eq_obj$reg$se
names(se_beta) <- eq_obj$reg$rhs
# SE de intercepto
se_beta0      <- eq_obj$int$se
names(se_beta0) <- "(Intercept)"
se_full <- rep(NA_real_, length(coef(lm_obj)))
names(se_full) <- names(coef(lm_obj))
se_full["(Intercept)"] <- se_beta0
se_full[names(se_beta)] <- se_beta
se_full
}
se_sard <- make_se_vec(lm_sard, eq_sard)
se_anch <- make_se_vec(lm_anch, eq_anch)
se_jack <- make_se_vec(lm_jack, eq_jack)
summary(fit_sem, standardized = TRUE)
stargazer(
lm_sard, lm_anch, lm_jack,
type = "latex",
title = "Sistema SUR (MLR, errores robustos)",
label = "tab:sur_lavaan_robust",
column.labels = c("Sardina", "Anchoveta", "Jurel"),
dep.var.labels = "Biomasa t+1",
dep.var.caption = "",                # sin fila extra
dep.var.labels.include = FALSE,      # quita ese encabezado largo feo
se = list(se_sard, se_anch, se_jack),
digits = 3,
single.row = TRUE,
omit.stat = c("f"),
no.space = TRUE,
float.env = "table",
notes = "Errores est√°ndar robustos (MLR, lavaan).",
notes.align = "l"
)
stargazer(
lm_sard, lm_anch, lm_jack,
type = "latex",
header = FALSE,
float = TRUE,
title = "Sistema SUR estimado con lavaan (MLR, errores robustos)",
label = "tab:SUR_results",
column.labels = c("Sardina", "Anchoveta", "Jurel"),
column.separate = c(1, 1, 1),
dep.var.labels = "Biomasa t+1",
dep.var.caption = "",
dep.var.labels.include = FALSE,
covariate.labels = c(
"Biomasa sardina (t)",
"Biomasa sardina (t)$^2$",
"Biomasa anchoveta (t)",
"Biomasa anchoveta (t)$^2$",
"Biomasa jurel (t)",
"Biomasa jurel (t)$^2$",
"SST (centrada)",
"SST$^2$",
"Clorofila-a",
"Clorofila-a$^2$",
"Interacci√≥n sardina--anchoveta",
"Interacci√≥n sardina--jurel",
"Interacci√≥n anchoveta--jurel",
"Constante"
),
se = list(se_sard, se_anch, se_jack),
digits = 3,
single.row = TRUE,
omit.stat = c("f"),
no.space = TRUE,
font.size = "scriptsize",
notes = ""
)
stargazer(
lm_sard, lm_anch, lm_jack,
type = "latex",
header = FALSE,
float = TRUE,
title = "Sistema SUR estimado con lavaan (MLR, errores robustos)",
label = "tab:SUR_results",
column.labels = c("Sardina", "Anchoveta", "Jurel"),
column.separate = c(1, 1, 1),
dep.var.labels = "Biomasa t+1",
dep.var.caption = "",
dep.var.labels.include = FALSE,
covariate.labels = c(
"Biomasa sardina (t)",
"Biomasa sardina (t)$^2$",
"Biomasa anchoveta (t)",
"Biomasa anchoveta (t)$^2$",
"Biomasa jurel (t)",
"Biomasa jurel (t)$^2$",
"SST (centrada)",
"SST$^2$",
"Clorofila-a",
"Clorofila-a$^2$",
"Interacci√≥n sardina--anchoveta",
"Interacci√≥n sardina--jurel",
"Interacci√≥n anchoveta--jurel",
"Constante"
),
se = list(se_sard, se_anch, se_jack),
digits = 3,
single.row = TRUE,
omit.stat = c("f"),
no.space = TRUE,
font.size = "scriptsize",
#### üî• LAS 3 L√çNEAS OBLIGATORIAS üî• ####
star.cutoffs = NA,   # elimina significancia autom√°tica
notes = "",          # evita texto residual
notes.append = FALSE # evita duplicados
)
# ---- Tus notas alineadas a la izquierda ----
cat("\\begin{flushleft}\n")
cat("\\scriptsize \\textit{Nota:} *p$<0.1$; **p$<0.05$; ***p$<0.01$.\\\\\n")
cat("\\scriptsize Errores est\\'andar robustos (MLR, lavaan).\\\\\n")
cat("\\end{flushleft}\n")
# Abrimos el entorno table a mano
cat("\\begin{table}[!htbp] \\centering\n")
cat("\\caption{Sistema SUR estimado con lavaan (MLR, errores robustos)}\n")
cat("\\label{tab:SUR_results}\n")
# stargazer SOLO genera el tabular (sin table, sin notas)
stargazer(
lm_sard, lm_anch, lm_jack,
type = "latex",
header = FALSE,
float = FALSE,              # <-- muy importante
title = "",
label = "",
column.labels = c("Sardina", "Anchoveta", "Jurel"),
column.separate = c(1, 1, 1),
dep.var.labels = "Biomasa t+1",
dep.var.caption = "",
dep.var.labels.include = FALSE,
covariate.labels = c(
"Biomasa sardina (t)",
"Biomasa sardina (t)$^2$",
"Biomasa anchoveta (t)",
"Biomasa anchoveta (t)$^2$",
"Biomasa jurel (t)",
"Biomasa jurel (t)$^2$",
"SST (centrada)",
"SST$^2$",
"Clorofila-a",
"Clorofila-a$^2$",
"Interacci√≥n sardina--anchoveta",
"Interacci√≥n sardina--jurel",
"Interacci√≥n anchoveta--jurel",
"Constante"
),
se = list(se_sard, se_anch, se_jack),
digits = 3,
single.row = TRUE,
omit.stat = c("f"),
no.space = TRUE,
font.size = "scriptsize",
omit.table.layout = "n",    # no secci√≥n de notas
notes = NULL
)
# Notas dentro del table, antes de cerrarlo
cat("\\begin{flushleft}\n")
cat("\\scriptsize \\textit{Nota:} *p$<0.1$; **p$<0.05$; ***p$<0.01$.\\\\\n")
cat("\\scriptsize Errores est\\'andar robustos (MLR, lavaan).\\\\\n")
cat("\\end{flushleft}\n")
cat("\\end{table}\n")
cat("\\begin{table}[!htbp] \\centering\n")
cat("\\caption{Sistema SUR estimado con lavaan (MLR, errores robustos)}\n")
cat("\\label{tab:SUR_results}\n")
# --- TABLA ---
stargazer(
lm_sard, lm_anch, lm_jack,
type = "latex",
header = FALSE,
float = FALSE,              # no crear entorno table extra
title = "",
label = "",
column.labels = c("Sardina", "Anchoveta", "Jurel"),
column.separate = c(1, 1, 1),
dep.var.labels = "Biomasa t+1",
dep.var.caption = "",
dep.var.labels.include = FALSE,
covariate.labels = c(
"Biomasa sardina (t)",
"Biomasa sardina (t)$^2$",
"Biomasa anchoveta (t)",
"Biomasa anchoveta (t)$^2$",
"Biomasa jurel (t)",
"Biomasa jurel (t)$^2$",
"SST (centrada)",
"SST$^2$",
"Clorofila-a",
"Clorofila-a$^2$",
"Interacci√≥n sardina--anchoveta",
"Interacci√≥n sardina--jurel",
"Interacci√≥n anchoveta--jurel",
"Constante"
),
se = list(se_sard, se_anch, se_jack),
digits = 3,
single.row = TRUE,
no.space = TRUE,
font.size = "scriptsize",
notes = "p<0.1; **p<0.05; ***p<0.01",
notes.append = "Errores estandar robustos (MLR, lavaan)."
)
cat("\\end{table}\n")
cat("\\begin{table}[!htbp] \\centering\n")
cat("\\caption{Sistema SUR estimado con lavaan (MLR, errores robustos)}\n")
cat("\\label{tab:SUR_results}\n")
# --- TABLA ---
stargazer(
lm_sard, lm_anch, lm_jack,
type = "latex",
header = FALSE,
float = FALSE,              # no crear entorno table extra
title = "",
label = "",
column.labels = c("Sardina", "Anchoveta", "Jurel"),
column.separate = c(1, 1, 1),
dep.var.labels = "Biomasa t+1",
dep.var.caption = "",
dep.var.labels.include = FALSE,
covariate.labels = c(
"Biomasa sardina (t)",
"Biomasa sardina (t)$^2$",
"Biomasa anchoveta (t)",
"Biomasa anchoveta (t)$^2$",
"Biomasa jurel (t)",
"Biomasa jurel (t)$^2$",
"SST (centrada)",
"SST$^2$",
"Clorofila-a",
"Clorofila-a$^2$",
"Interacci√≥n sardina--anchoveta",
"Interacci√≥n sardina--jurel",
"Interacci√≥n anchoveta--jurel",
"Constante"
),
se = list(se_sard, se_anch, se_jack),
digits = 3,
single.row = TRUE,
no.space = TRUE,
font.size = "scriptsize",
notes = "p<0.1; **p<0.05; ***p<0.01",
notes.append = TRUE
)
cat("\\end{table}\n")
cat("\\begin{table}[!htbp] \\centering\n")
cat("\\caption{Sistema SUR estimado con lavaan (MLR, errores robustos)}\n")
cat("\\label{tab:SUR_results}\n")
# --- TABLA ---
stargazer(
lm_sard, lm_anch, lm_jack,
type = "latex",
header = FALSE,
float = FALSE,              # no crear entorno table extra
title = "",
label = "",
column.labels = c("Sardina", "Anchoveta", "Jurel"),
column.separate = c(1, 1, 1),
dep.var.labels = "Biomasa t+1",
dep.var.caption = "",
dep.var.labels.include = FALSE,
covariate.labels = c(
"Biomasa sardina (t)",
"Biomasa sardina (t)$^2$",
"Biomasa anchoveta (t)",
"Biomasa anchoveta (t)$^2$",
"Biomasa jurel (t)",
"Biomasa jurel (t)$^2$",
"SST (centrada)",
"SST$^2$",
"Clorofila-a",
"Clorofila-a$^2$",
"Interacci√≥n sardina--anchoveta",
"Interacci√≥n sardina--jurel",
"Interacci√≥n anchoveta--jurel",
"Constante"
),
se = list(se_sard, se_anch, se_jack),
digits = 3,
single.row = TRUE,
no.space = TRUE,
font.size = "scriptsize",
notes = "Errores estandar robustos (MLR, lavaan).",
notes.append = TRUE
)
cat("\\end{table}\n")
cat("\\begin{table}[!htbp] \\centering\n")
cat("\\caption{Sistema SUR estimado con lavaan (MLR, errores robustos)}\n")
cat("\\label{tab:SUR_results}\n")
# --- TABLA ---
stargazer(
lm_sard, lm_anch, lm_jack,
type = "latex",
header = FALSE,
float = FALSE,              # no crear entorno table extra
title = "",
label = "",
column.labels = c("Sardina", "Anchoveta", "Jurel"),
column.separate = c(1, 1, 1),
dep.var.labels = "Biomasa t+1",
dep.var.caption = "",
dep.var.labels.include = FALSE,
covariate.labels = c(
"Biomasa sardina (t)",
"Biomasa sardina (t)$^2$",
"Biomasa anchoveta (t)",
"Biomasa anchoveta (t)$^2$",
"Biomasa jurel (t)",
"Biomasa jurel (t)$^2$",
"SST (centrada)",
"SST$^2$",
"Clorofila-a",
"Clorofila-a$^2$",
"Interacci√≥n sardina--anchoveta",
"Interacci√≥n sardina--jurel",
"Interacci√≥n anchoveta--jurel",
"Constante"
),
se = list(se_sard, se_anch, se_jack),
digits = 3,
single.row = TRUE,
no.space = TRUE,
font.size = "scriptsize",
notes = "Errores estandar robustos (MLR, lavaan).",
notes.append = FALSE
)
cat("\\end{table}\n")
###----------------------------------------------###
###               Biomass data                   ###
### and interpolation of mackerel missing values ###
###----------------------------------------------###
rm(list = ls())
gc()
# Define directory
usuario <- Sys.info()[["user"]]
# computador <- Sys.info()[["nodename"]]  # Alternativamente puedes usar esto
if (usuario == "felip") {
dirdata <- "C:/Users/felip/OneDrive - Universidad de Concepci√≥n/FONDECYT Iniciacion/Data/"
} else if (usuario == "FACEA") {
dirdata <- "C:/Users/FACEA/OneDrive - Universidad de Concepci√≥n/FONDECYT Iniciacion/Data/"
} else if (usuario == "Felipe") {
dirdata <- "D:/OneDrive - Universidad de Concepci√≥n/FONDECYT Iniciacion/Data/"
} else {
stop("Usuario no reconocido. Defina el directorio correspondiente.")
}
rm(usuario)
# Load packages
library(readxl)
library(tidyverse)
#Anchovy and sardine biomass
anch_sard_biomass <- read_excel(paste0(dirdata, "IFOP/3. ESTIMACIONES CRUCERO ACUSTICO.xlsx"), sheet = "SARDINA-ANCHOVETA")
anch_sard_biomass <- anch_sard_biomass[, c(1, 2, 3, 4)]
anch_sard_biomass <- anch_sard_biomass[-1, ]
colnames(anch_sard_biomass) <- c("year", "cruise", "sardine_biomass", "anchoveta_biomass")
anch_sard_biomass <- anch_sard_biomass %>%
filter(str_detect(cruise, "Reclas")) %>%  ## Summer survey!
dplyr::select(-c(cruise)) %>%
mutate(across(ends_with("biomass"), ~as.numeric(.)))
anch_sard_biomass$year <- as.numeric(anch_sard_biomass$year)
# Jurel biomass
jurel_biomass <- read_excel(paste0(dirdata, "IFOP/3. ESTIMACIONES CRUCERO ACUSTICO.xlsx"), sheet = "JUREL")
jurel_biomass <- jurel_biomass[, c(1, 3,8)]
jurel_biomass <- jurel_biomass[-1, ]
colnames(jurel_biomass) <- c("year", "jurel_biomass_cs", "jurel_biomass_no")
jurel_biomass <- jurel_biomass %>%
mutate(across(ends_with("biomass_cs"), ~as.numeric(.))) %>%
mutate(across(ends_with("biomass_no"), ~as.numeric(.))) %>%
mutate(jurel_biomass_cs = ifelse(jurel_biomass_cs == 0, NA, jurel_biomass_cs)) %>%
mutate(jurel_biomass_no = ifelse(jurel_biomass_no == 0, NA, jurel_biomass_no))
jurel_biomass$year <- as.numeric(jurel_biomass$year)
## --> Add the other biomass database
biomass_v2 <- read_excel(paste0(dirdata, "IFOP/Datos_estimaci√≥n biomasa.xlsx")) %>%
dplyr::rename(year = `A√±o (calendario/.5 semestral)`,
ind_chl_per_ecu = `Reclutas (millones individuos)`,
sb_chl_per_ecu = `Biomasa desovante (t)`) %>%
dplyr::filter(Especie == "Jurel",
year >= 2000) %>%
dplyr::select(c("year", "ind_chl_per_ecu", "sb_chl_per_ecu"))
jurel_biomass <- left_join(jurel_biomass, biomass_v2, by = "year")
rm(biomass_v2)
## --> Add the harvest database
harvest <- readRDS("data/harvest/sernapesca_v2.rds") %>%
filter(specie == "JUREL") %>%
select(c(year, total_harvest_sernapesca_v2_centro_sur))
jurel_biomass <- left_join(jurel_biomass, harvest, by = "year")
rm(harvest)
# GLM models with log link
model1 <- glm(
jurel_biomass_cs ~ jurel_biomass_no + sb_chl_per_ecu,
family = Gamma(link = "log"),
data = jurel_biomass
)
model2 <- glm(
jurel_biomass_cs ~ jurel_biomass_no + I(jurel_biomass_no^2),
family = Gamma(link = "log"),
data = jurel_biomass)
model3 <- glm(
jurel_biomass_cs ~ jurel_biomass_no + I(jurel_biomass_no^2) + sb_chl_per_ecu,
family = Gamma(link = "log"),
data = jurel_biomass
)
model4 <- glm(
jurel_biomass_cs ~ jurel_biomass_no + I(jurel_biomass_no^2) + jurel_biomass_no:sb_chl_per_ecu,
family = Gamma(link = "log"),
data = jurel_biomass)
model5 <- glm(
jurel_biomass_cs ~ jurel_biomass_no + I(jurel_biomass_no^2) + I(sb_chl_per_ecu^2) + jurel_biomass_no:sb_chl_per_ecu,
family = Gamma(link = "log"),
data = jurel_biomass)
library(stargazer)
stargazer(model1, model2, model3, model4, model5,
type = "text",
title = "Modelos Gamma con Enlace Log para Biomasa de Jurel",
dep.var.labels = "jurel_biomass_cs",
column.labels = c("M1", "M2", "M3", "M4", "M5"),
digits = 4,
no.space = TRUE)
r2_glm <- function(model) cor(model$y, model$fitted)^2
r2_glm(model1)
r2_glm(model2)
r2_glm(model3)
r2_glm(model4)
r2_glm(model5)
cor(model5$y, model5$fitted)
cor(model5$y, model5$fitted)^2
