mutate(
new_trip = case_when(
NUMERO_LANCE_EX == 1 ~ 1L,
is.na(lag(FECHA_HORA_ZARPE)) ~ 1L,
FECHA_HORA_ZARPE != lag(FECHA_HORA_ZARPE) ~ 1L,
TRUE ~ 0L
),
trip_seq = cumsum(new_trip)
) %>%
ungroup() %>%
mutate(
trip_id = paste(COD_BARCO, trip_seq, sep = "_")
)
# Viajes por barco–año
trips_vy <- log_spf %>%
distinct(COD_BARCO, year, trip_id) %>%
count(COD_BARCO, year, name = "T_vy")
Mode <- function(x) {
x <- x[!is.na(x)]
if (length(x) == 0) return(NA)
ux <- unique(x)
ux[which.max(tabulate(match(x, ux)))]
}
log_spf <- log_spf %>%
mutate(
TIPO_EMB_clean = if_else(
TIPO_EMB %in% c("1", "2", "3"),
NA_character_,
TIPO_EMB
)
)
vessel_chars <- log_spf %>%
group_by(COD_BARCO) %>%
summarise(
TIPO_FLOTA = Mode(TIPO_FLOTA),
TIPO_EMB   = Mode(TIPO_EMB_clean),
CAPACIDAD_BODEGA = median(CAPACIDAD_BODEGA, na.rm = TRUE),
.groups = "drop"
)
vessel_chars <- vessel_chars %>%
mutate(
TIPO_EMB = replace_na(TIPO_EMB, "UNK")
)
poisson_df <- trips_vy %>%
left_join(vessel_chars, by = "COD_BARCO")
View(poisson_df)
# (A) Define aquí tus especies SPF
spf_codes <- c(26, 33, 114)
# Dfinir viajes
log_spf <- logbooks %>%
arrange(COD_BARCO, FECHA_HORA_ZARPE, FECHA_LANCE) %>%
group_by(COD_BARCO) %>%
mutate(
new_trip = case_when(
NUMERO_LANCE_EX == 1 ~ 1L,
is.na(lag(FECHA_HORA_ZARPE)) ~ 1L,
FECHA_HORA_ZARPE != lag(FECHA_HORA_ZARPE) ~ 1L,
TRUE ~ 0L
),
trip_seq = cumsum(new_trip)
) %>%
ungroup() %>%
mutate(
trip_id = paste(COD_BARCO, trip_seq, sep = "_")
)
# Viajes por barco–año
trips_vy <- log_spf %>%
distinct(COD_BARCO, year, trip_id) %>%
count(COD_BARCO, year, name = "T_vy")
Mode <- function(x) {
x <- x[!is.na(x)]
if (length(x) == 0) return(NA)
ux <- unique(x)
ux[which.max(tabulate(match(x, ux)))]
}
log_spf <- log_spf %>%
mutate(
TIPO_EMB_clean = if_else(
TIPO_EMB %in% c("1", "2", "3"),
NA_character_,
TIPO_EMB
)
)
# Calculate harvest
harvest_vy <- log_spf %>%
filter(COD_ESPECIE %in% spf_codes) %>%
group_by(COD_BARCO, year) %>%
summarise(
H_vy = sum(CAPTURA_RETENIDA, na.rm = TRUE),
.groups = "drop"
)
View(harvest_vy)
# Calculate harvest share
harvest_shares <- log_spf %>%
filter(COD_ESPECIE %in% spf_codes) %>%
group_by(COD_BARCO) %>%
summarise(
H_tot = sum(CAPTURA_RETENIDA, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(
share_v = H_tot / sum(H_tot)
)
View(harvest_shares)
shares_vs <- log_spf %>%
filter(COD_ESPECIE %in% spf_codes) %>%
group_by(COD_BARCO, COD_ESPECIE) %>%
summarise(
H_vs = sum(CAPTURA_RETENIDA, na.rm = TRUE),
.groups = "drop"
) %>%
group_by(COD_ESPECIE) %>%
mutate(
share_vs = H_vs / sum(H_vs)
) %>%
ungroup()
View(shares_vs)
View(log_spf)
harvest_vy <- log_spf %>%
filter(COD_ESPECIE %in% spf_codes) %>%
group_by(TIPO_FLOTA, COD_ESPECIE, COD_BARCO, year) %>%
summarise(
H_vys = sum(CAPTURA_RETENIDA, na.rm = TRUE),
.groups = "drop"
)
View(harvest_vy)
harvest_vys <- log_spf %>%
filter(COD_ESPECIE %in% spf_codes) %>%
group_by(TIPO_FLOTA, COD_ESPECIE, COD_BARCO, year) %>%
summarise(
H_vys = sum(CAPTURA_RETENIDA, na.rm = TRUE),
.groups = "drop"
)
# shares_vsf <- log_spf %>%
#   filter(COD_ESPECIE %in% spf_codes) %>%
#   group_by(TIPO_FLOTA, COD_ESPECIE, COD_BARCO) %>%
#   summarise(
#     H_vsf = sum(CAPTURA_RETENIDA, na.rm = TRUE),
#     .groups = "drop"
#   ) %>%
#   group_by(TIPO_FLOTA, COD_ESPECIE) %>%
#   mutate(
#     share_vsf = H_vsf / sum(H_vsf)
#   ) %>%
#   ungroup()
# Get vessel characteristics
vessel_chars <- log_spf %>%
group_by(COD_BARCO) %>%
summarise(
TIPO_FLOTA = Mode(TIPO_FLOTA),
TIPO_EMB   = Mode(TIPO_EMB_clean),
CAPACIDAD_BODEGA = median(CAPACIDAD_BODEGA, na.rm = TRUE),
.groups = "drop"
)
vessel_chars <- vessel_chars %>%
mutate(
TIPO_EMB = replace_na(TIPO_EMB, "UNK")
)
poisson_df <- trips_vy %>%
left_join(vessel_chars, by = "COD_BARCO") %>%
left_join(harvest_vys, by = c("COD_BARCO", "COD_ESPECIE", "year"))
harvest_vy_wide <- harvest_vys %>%
select(COD_BARCO, year, COD_ESPECIE, H_vys) %>%
pivot_wider(
names_from  = COD_ESPECIE,
values_from = H_vys,
names_prefix = "H_",
values_fill = 0
)
# shares_vsf <- log_spf %>%
#   filter(COD_ESPECIE %in% spf_codes) %>%
#   group_by(TIPO_FLOTA, COD_ESPECIE, COD_BARCO) %>%
#   summarise(
#     H_vsf = sum(CAPTURA_RETENIDA, na.rm = TRUE),
#     .groups = "drop"
#   ) %>%
#   group_by(TIPO_FLOTA, COD_ESPECIE) %>%
#   mutate(
#     share_vsf = H_vsf / sum(H_vsf)
#   ) %>%
#   ungroup()
# Get vessel characteristics
vessel_chars <- log_spf %>%
group_by(COD_BARCO) %>%
summarise(
TIPO_FLOTA = Mode(TIPO_FLOTA),
TIPO_EMB   = Mode(TIPO_EMB_clean),
CAPACIDAD_BODEGA = median(CAPACIDAD_BODEGA, na.rm = TRUE),
.groups = "drop"
)
vessel_chars <- vessel_chars %>%
mutate(
TIPO_EMB = replace_na(TIPO_EMB, "UNK")
)
poisson_df <- trips_vy %>%
left_join(vessel_chars, by = "COD_BARCO") %>%
left_join(harvest_vy_wide, by = c("COD_BARCO", "year"))
View(poisson_df)
library(MASS)
pois_ind <- glm.nb(
T_vy ~ CAPACIDAD_BODEGA + H_26 + H_33 + H_114 + TIPO_EMB,
data = poisson_df %>% filter(TIPO_FLOTA == "IND")
)
pois_art <- glm.nb(
T_vy ~ CAPACIDAD_BODEGA + H_26 + H_33 + H_114 + TIPO_EMB,
data = poisson_df %>% filter(TIPO_FLOTA == "ART")
)
library(stargazer)
stargazer(
pois_ind, pois_art,
type = "latex",
title = "Annual Fishing Trips (Negative Binomial Models)",
column.labels = c("Industrial fleet", "Artisanal fleet"),
dep.var.labels = "Number of trips per vessel-year",
omit.stat = c("aic", "bic"),
no.space = TRUE,
digits = 3,
font.size = "footnotesize",
star.cutoffs = c(0.1, 0.05, 0.01),
notes = c(
"Negative binomial models estimated separately by fleet segment.",
"Allocated harvest is computed from historical vessel shares and aggregate TAC."
),
notes.append = FALSE,
notes.line.sep = "\\\\"
)
# Calculate harvest
harvest_vys <- log_spf %>%
filter(COD_ESPECIE %in% spf_codes) %>%
group_by(TIPO_FLOTA, COD_ESPECIE, COD_BARCO, year) %>%
summarise(
H_vys = sum(CAPTURA_RETENIDA, na.rm = TRUE)/1000,
.groups = "drop"
)
harvest_vy_wide <- harvest_vys %>%
select(COD_BARCO, year, COD_ESPECIE, H_vys) %>%
pivot_wider(
names_from  = COD_ESPECIE,
values_from = H_vys,
names_prefix = "H_",
values_fill = 0
)
library(dplyr)
library(fixest)
library(lubridate)
# (A) Define aquí tus especies SPF
spf_codes <- c(26, 33, 114)
# Dfinir viajes
log_spf <- logbooks %>%
arrange(COD_BARCO, FECHA_HORA_ZARPE, FECHA_LANCE) %>%
group_by(COD_BARCO) %>%
mutate(
new_trip = case_when(
NUMERO_LANCE_EX == 1 ~ 1L,
is.na(lag(FECHA_HORA_ZARPE)) ~ 1L,
FECHA_HORA_ZARPE != lag(FECHA_HORA_ZARPE) ~ 1L,
TRUE ~ 0L
),
trip_seq = cumsum(new_trip)
) %>%
ungroup() %>%
mutate(
trip_id = paste(COD_BARCO, trip_seq, sep = "_")
)
# Viajes por barco–año
trips_vy <- log_spf %>%
distinct(COD_BARCO, year, trip_id) %>%
count(COD_BARCO, year, name = "T_vy")
Mode <- function(x) {
x <- x[!is.na(x)]
if (length(x) == 0) return(NA)
ux <- unique(x)
ux[which.max(tabulate(match(x, ux)))]
}
log_spf <- log_spf %>%
mutate(
TIPO_EMB_clean = if_else(
TIPO_EMB %in% c("1", "2", "3"),
NA_character_,
TIPO_EMB
)
)
# Calculate harvest
harvest_vys <- log_spf %>%
filter(COD_ESPECIE %in% spf_codes) %>%
group_by(TIPO_FLOTA, COD_ESPECIE, COD_BARCO, year) %>%
summarise(
H_vys = sum(CAPTURA_RETENIDA, na.rm = TRUE)/1000,
.groups = "drop"
)
harvest_vy_wide <- harvest_vys %>%
select(COD_BARCO, year, COD_ESPECIE, H_vys) %>%
pivot_wider(
names_from  = COD_ESPECIE,
values_from = H_vys,
names_prefix = "H_",
values_fill = 0
)
library(stargazer)
stargazer(
pois_ind, pois_art,
type = "latex",
title = "Annual Fishing Trips (Negative Binomial Models)",
column.labels = c("Industrial fleet", "Artisanal fleet"),
dep.var.labels = "Number of trips per vessel-year",
omit.stat = c("aic", "bic"),
no.space = TRUE,
digits = 3,
font.size = "footnotesize",
star.cutoffs = c(0.1, 0.05, 0.01),
notes = c(
"Negative binomial models estimated separately by fleet segment.",
"Allocated harvest is computed from historical vessel shares and aggregate TAC."
),
notes.append = FALSE,
notes.line.sep = "\\\\"
)
library(stargazer)
stargazer(
pois_ind, pois_art,
type = "latex",
float = FALSE,
title = "Annual Fishing Trips (Negative Binomial Models)",
column.labels = c("Industrial fleet", "Artisanal fleet"),
dep.var.labels = "Number of trips per vessel-year",
omit.stat = c("aic", "bic"),
no.space = TRUE,
digits = 3,
font.size = "footnotesize",
star.cutoffs = c(0.1, 0.05, 0.01),
notes = c(
"Negative binomial models estimated separately by fleet segment.",
"Allocated harvest is computed from historical vessel shares and aggregate TAC."
),
notes.append = FALSE,
notes.line.sep = "\\\\"
)
library(stargazer)
cat("\\begin{table}[!htbp]\n")
cat("\\centering\n")
cat("\\caption{Annual Fishing Trips (Negative Binomial Models)}\n")
cat("\\label{tab:poisson_results}\n")
stargazer(
pois_ind, pois_art,
type = "latex",
header = FALSE,
float = FALSE,              # prevents stargazer from creating a duplicate table env
title = "",
label = "",
column.labels = c("Industrial fleet", "Artisanal fleet"),
column.separate = c(1, 1),
dep.var.labels = "Number of trips per vessel-year",
dep.var.caption = "",
dep.var.labels.include = FALSE,
covariate.labels = c(
"Sardine biomass (t)",
"Sardine biomass (t)$^2$",
"Anchovy biomass (t)",
"Anchovy biomass (t)$^2$",
"Jack mackerel biomass (t)",
"Jack mackerel biomass (t)$^2$",
"SST",
"SST$^2$",
"Chlorophyll-a",
"Chlorophyll-a$^2$",
"Sardine × Anchovy",
"Sardine × Jack mackerel",
"Anchovy × Jack mackerel",
"Constant"
),
se = list(se_sard, se_anch, se_jack),
digits = 3,
single.row = TRUE,
omit.stat = c("f"),
no.space = TRUE,
font.size = "footnotesize",
notes = "Negative binomial models estimated separately by fleet segment. Allocated harvest is computed from historical vessel shares and aggregate TAC.",
notes.append = FALSE
)
cat("\\end{table}\n")
library(stargazer)
cat("\\begin{table}[!htbp]\n")
cat("\\centering\n")
cat("\\caption{Annual Fishing Trips (Negative Binomial Models)}\n")
cat("\\label{tab:poisson_results}\n")
stargazer(
pois_ind, pois_art,
type = "latex",
header = FALSE,
float = FALSE,              # prevents stargazer from creating a duplicate table env
title = "",
label = "",
column.labels = c("Industrial fleet", "Artisanal fleet"),
column.separate = c(1, 1),
dep.var.labels = "Number of trips per vessel-year",
dep.var.caption = "",
dep.var.labels.include = FALSE,
digits = 3,
single.row = TRUE,
omit.stat = c("f"),
no.space = TRUE,
font.size = "footnotesize",
notes = "Negative binomial models estimated separately by fleet segment. Allocated harvest is computed from historical vessel shares and aggregate TAC.",
notes.append = FALSE
)
cat("\\end{table}\n")
library(stargazer)
cat("\\begin{table}[!htbp]\n")
cat("\\centering\n")
cat("\\caption{Annual Fishing Trips (Negative Binomial Models)}\n")
cat("\\label{tab:poisson_results}\n")
stargazer(
pois_ind, pois_art,
type = "latex",
header = FALSE,
float = FALSE,              # prevents stargazer from creating a duplicate table env
title = "",
label = "",
column.labels = c("Industrial fleet", "Artisanal fleet"),
column.separate = c(1, 1),
dep.var.labels = "Number of trips per vessel-year",
dep.var.caption = "",
dep.var.labels.include = FALSE,
digits = 3,
single.row = TRUE,
omit.stat = c("f"),
no.space = TRUE,
font.size = "footnotesize",
notes = "Negative binomial models estimated separately by fleet segment. \\ Allocated harvest is computed from historical vessel shares and aggregate TAC.",
notes.append = FALSE
)
cat("\\end{table}\n")
library(stargazer)
cat("\\begin{table}[!htbp]\n")
cat("\\centering\n")
cat("\\caption{Annual Fishing Trips (Negative Binomial Models)}\n")
cat("\\label{tab:poisson_results}\n")
stargazer(
pois_ind, pois_art,
type = "latex",
header = FALSE,
float = FALSE,              # prevents stargazer from creating a duplicate table env
title = "",
label = "",
column.labels = c("Industrial fleet", "Artisanal fleet"),
column.separate = c(1, 1),
dep.var.labels = "Number of trips per vessel-year",
dep.var.caption = "",
dep.var.labels.include = FALSE,
digits = 3,
single.row = TRUE,
omit.stat = c("f"),
no.space = TRUE,
font.size = "footnotesize",
notes = "Negative binomial models estimated separately by fleet segment. \\\ Allocated harvest is computed from historical vessel shares and aggregate TAC.",
notes.append = FALSE
)
cat("\\end{table}\n")
library(stargazer)
cat("\\begin{table}[!htbp]\n")
cat("\\centering\n")
cat("\\caption{Annual Fishing Trips (Negative Binomial Models)}\n")
cat("\\label{tab:poisson_results}\n")
stargazer(
pois_ind, pois_art,
type = "latex",
header = FALSE,
float = FALSE,              # prevents stargazer from creating a duplicate table env
title = "",
label = "",
column.labels = c("Industrial fleet", "Artisanal fleet"),
column.separate = c(1, 1),
dep.var.labels = "Number of trips per vessel-year",
dep.var.caption = "",
dep.var.labels.include = FALSE,
digits = 3,
single.row = TRUE,
omit.stat = c("f"),
no.space = TRUE,
font.size = "footnotesize",
notes = "Negative binomial models estimated separately by fleet segment. \\\\ Allocated harvest is computed from historical vessel shares and aggregate TAC.",
notes.append = FALSE
)
cat("\\end{table}\n")
library(stargazer)
cat("\\begin{table}[!htbp]\n")
cat("\\centering\n")
cat("\\caption{Annual Fishing Trips (Negative Binomial Models)}\n")
cat("\\label{tab:poisson_results}\n")
stargazer(
pois_ind, pois_art,
type = "latex",
header = FALSE,
float = FALSE,              # prevents stargazer from creating a duplicate table env
title = "",
label = "",
column.labels = c("Industrial fleet", "Artisanal fleet"),
column.separate = c(1, 1),
dep.var.labels = "Number of trips per vessel-year",
dep.var.caption = "",
dep.var.labels.include = FALSE,
digits = 3,
single.row = TRUE,
omit.stat = c("f"),
no.space = TRUE,
font.size = "footnotesize",
notes = c("Negative binomial models estimated separately by fleet segment.", "Allocated harvest is computed from historical vessel shares and aggregate TAC."),
notes.append = FALSE
)
cat("\\end{table}\n")
logbooks <- readRDS("data/logbooks/logbooks.rds")
str(logbooks)
