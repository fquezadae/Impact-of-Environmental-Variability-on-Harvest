sea_area <- st_difference(chile_buffer, south_america)
#---------------------------------
# Filtrar solo grilla en el mar
#---------------------------------
inside_sea <- st_intersects(grid_sf, sea_area, sparse = FALSE)[,1]
grid_filtered <- grid_sf[inside_sea, ]
#---------------------------------
# Distancias a la costa
#---------------------------------
grid_filtered$dist2coast_m  <- as.numeric(st_distance(grid_filtered, chile_mainland))
grid_filtered$dist2coast_km <- grid_filtered$dist2coast_m / 1000
#---------------------------------
# Extraer lon/lat de nuevo para merge
#---------------------------------
grid_filtered_lonlat <- st_transform(grid_filtered, 4326) %>%
mutate(lon = st_coordinates(.)[,1],
lat = st_coordinates(.)[,2]) %>%
st_drop_geometry() %>%
as.data.table()
#---------------------------------
# Merge con dataset original
#---------------------------------
keep_cells <- grid_filtered_lonlat %>%
select(lon, lat, dist2coast_m, dist2coast_km)
env_coast_dt <- env_dt %>%
semi_join(keep_cells, by = c("lon", "lat")) %>%
left_join(keep_cells, by = c("lon", "lat"))
#---------------------------------
# Guardar dataset final
#---------------------------------
saveRDS(env_coast_dt,
file = "data/env/2000-2011/EnvCoastDaily_2000_2011_0.25deg.rds")
#---------------------------------
# Chequeo rápido
#---------------------------------
cat("Celdas originales:", nrow(env_dt %>% distinct(lon, lat)), "\n")
cat("Celdas filtradas :", nrow(env_coast_dt %>% distinct(lon, lat)), "\n")
library(ggplot2)
# Pasar todo a lat/lon (EPSG:4326) para graficar
chile_plot   <- st_transform(chile_mainland, 4326)
buffer_plot  <- st_transform(chile_buffer, 4326)
sea_plot     <- st_transform(sea_area, 4326)
grid_plot    <- st_as_sf(grid_filtered, crs = 32719) %>%
st_transform(4326)
ggplot() +
geom_sf(data = buffer_plot, fill = "lightblue", color = NA, alpha = 0.3) +
geom_sf(data = sea_plot, fill = "lightblue", color = "blue", alpha = 0.2) +
geom_sf(data = chile_plot, fill = "gray60", color = "black") +
geom_sf(data = grid_plot, aes(color = dist2coast_km), size = 0.4) +
scale_color_viridis_c(option = "plasma", name = "Distancia costa (km)") +
coord_sf(xlim = c(-82, -70), ylim = c(-42, -30)) +
theme_minimal() +
labs(title = "Zona marítima chilena (≤ 200 nm, solo mar)",
subtitle = "Grid ambiental 0.125° filtrado frente a Chile continental",
x = "Longitud", y = "Latitud")
ggsave("figsenv_data_map.svg", p,
device = svglite::svglite, width = 10, height = 6, units = "in")
p <- ggplot() +
geom_sf(data = buffer_plot, fill = "lightblue", color = NA, alpha = 0.3) +
geom_sf(data = sea_plot, fill = "lightblue", color = "blue", alpha = 0.2) +
geom_sf(data = chile_plot, fill = "gray60", color = "black") +
geom_sf(data = grid_plot, aes(color = dist2coast_km), size = 0.4) +
scale_color_viridis_c(option = "plasma", name = "Distancia costa (km)") +
coord_sf(xlim = c(-82, -70), ylim = c(-42, -30)) +
theme_minimal() +
labs(title = "Zona marítima chilena (≤ 200 nm, solo mar)",
subtitle = "Grid ambiental 0.125° filtrado frente a Chile continental",
x = "Longitud", y = "Latitud")
ggsave("figsenv_data_map.svg", p,
device = svglite::svglite, width = 6, height = 10, units = "in")
ggsave("figs/env_data_map.svg", p,
device = svglite::svglite, width = 6, height = 10, units = "in")
ggsave("figs/env_data_map.svg", p,
device = svglite::svglite)
install.packages("gt")
install.packages("gt")
options(htmltools.dir.version = FALSE)
library(dplyr)
library(knitr)
library(kableExtra)
library(gt)
sur_df <- readRDS("tables/table_SUR_stock.rds")
rm(list = ls())
gc()
# Definir directorios según usuario
usuario <- Sys.info()[["user"]]
# computador <- Sys.info()[["nodename"]]  # Alternativamente puedes usar esto
if (usuario == "felip") {
dirdata <- "C:/Users/felip/OneDrive - Universidad de Concepción/FONDECYT Iniciacion/Data/"
} else if (usuario == "FACEA") {
dirdata <- "C:/Users/FACEA/OneDrive - Universidad de Concepción/FONDECYT Iniciacion/Data/"
} else {
stop("Usuario no reconocido. Defina el directorio correspondiente.")
}
rm(usuario)
env_dt <- readRDS("data/env/EnvCoastDaily_2012_2025_0.125deg.rds")
fit_biomasa <- fit_no_wind
rm(list = ls())
gc()
# Definir directorios según usuario
usuario <- Sys.info()[["user"]]
# computador <- Sys.info()[["nodename"]]  # Alternativamente puedes usar esto
if (usuario == "felip") {
dirdata <- "C:/Users/felip/OneDrive - Universidad de Concepción/FONDECYT Iniciacion/Data/"
} else if (usuario == "FACEA") {
dirdata <- "C:/Users/FACEA/OneDrive - Universidad de Concepción/FONDECYT Iniciacion/Data/"
} else {
stop("Usuario no reconocido. Defina el directorio correspondiente.")
}
rm(usuario)
env_dt <- readRDS("data/env/EnvCoastDaily_2012_2025_0.125deg.rds")
detach("package:gt", unload = TRUE)
rm(list = ls())
gc()
# Definir directorios según usuario
usuario <- Sys.info()[["user"]]
# computador <- Sys.info()[["nodename"]]  # Alternativamente puedes usar esto
if (usuario == "felip") {
dirdata <- "C:/Users/felip/OneDrive - Universidad de Concepción/FONDECYT Iniciacion/Data/"
} else if (usuario == "FACEA") {
dirdata <- "C:/Users/FACEA/OneDrive - Universidad de Concepción/FONDECYT Iniciacion/Data/"
} else {
stop("Usuario no reconocido. Defina el directorio correspondiente.")
}
rm(usuario)
env_dt <- readRDS("data/env/EnvCoastDaily_2012_2025_0.125deg.rds")
rm(list = ls())
gc()
# Definir directorios según usuario
usuario <- Sys.info()[["user"]]
# computador <- Sys.info()[["nodename"]]  # Alternativamente puedes usar esto
if (usuario == "felip") {
dirdata <- "C:/Users/felip/OneDrive - Universidad de Concepción/FONDECYT Iniciacion/Data/"
} else if (usuario == "FACEA") {
dirdata <- "C:/Users/FACEA/OneDrive - Universidad de Concepción/FONDECYT Iniciacion/Data/"
} else {
stop("Usuario no reconocido. Defina el directorio correspondiente.")
}
rm(usuario)
env_dt <- readRDS("data/env/EnvCoastDaily_2012_2025_0.125deg.rds")
file.exists("data/env/EnvCoastDaily_2012_2025_0.125deg.rds")
warnings()
pagedown::chrome_print("slides.html", output = "slides.pdf")
pagedown::chrome_print("slides.html", output = "slides.pdf")
options(htmltools.dir.version = FALSE)
pagedown::chrome_print("slides.html", output = "slides.pdf")
pagedown::chrome_print("slides.html", output = "slides.pdf")
pagedown::chrome_print("slides.html", output = "slides.pdf")
pagedown::chrome_print("slides.html", output = "slides.pdf")
pagedown::chrome_print("slides.html", output = "slides.pdf")
rm(list = ls())
gc()
# Definir directorios según usuario
usuario <- Sys.info()[["user"]]
# computador <- Sys.info()[["nodename"]]  # Alternativamente puedes usar esto
if (usuario == "felip") {
dirdata <- "C:/Users/felip/OneDrive - Universidad de Concepción/FONDECYT Iniciacion/Data/"
} else if (usuario == "FACEA") {
dirdata <- "C:/Users/FACEA/OneDrive - Universidad de Concepción/FONDECYT Iniciacion/Data/"
} else {
stop("Usuario no reconocido. Defina el directorio correspondiente.")
}
rm(usuario)
env_dt <- readRDS("data/env/EnvCoastDaily_2012_2025_0.125deg.rds")
env_dt_00_11 <- readRDS("data/env/2000-2011/EnvCoastDaily_2000_2011_0.25deg.rds")
biomass <- readRDS("data/biomass/biomass_dt.rds")
logbooks <- readRDS("data/logbooks/logbooks.rds")
library(dplyr)
library(data.table)
library(lubridate)
library(sf)
library(rnaturalearth)
library(ggplot2)
library(tidyr)
library(purrr)
# Build shares per vessel/fleet/year/species
vessel_species_year <- logbooks %>%
filter(year >= 2019) %>%
select(COD_BARCO, TIPO_FLOTA, year, NOMBRE_ESPECIE, CAPTURA_RETENIDA) %>%
group_by(COD_BARCO, TIPO_FLOTA, year, NOMBRE_ESPECIE) %>%
summarise(total_catch = sum(CAPTURA_RETENIDA, na.rm = TRUE), .groups = "drop") %>%
group_by(COD_BARCO, TIPO_FLOTA, year) %>%
mutate(species_share = total_catch / sum(total_catch, na.rm = TRUE)) %>%
ungroup() %>%
select(-total_catch) %>%
complete(COD_BARCO, TIPO_FLOTA, year, NOMBRE_ESPECIE, fill = list(species_share = 0)) %>%
group_by(COD_BARCO, TIPO_FLOTA, year) %>%
filter(sum(species_share, na.rm = TRUE) > 0) %>%
group_by(COD_BARCO, TIPO_FLOTA, NOMBRE_ESPECIE) %>%
summarise(species_share = mean(species_share, na.rm = TRUE), .groups = "drop") %>%
pivot_wider(
names_from = NOMBRE_ESPECIE,
values_from = species_share,
values_fill = 0
) %>%
# here just add missing columns if they don't exist
{ if(!"ANCHOVETA" %in% names(.)) .$ANCHOVETA <- 0; . } %>%
{ if(!"SARDINA COMUN" %in% names(.)) .$`SARDINA COMUN` <- 0; . } %>%
{ if(!"JUREL" %in% names(.)) .$JUREL <- 0; . } %>%
mutate(
Other = 1 - ANCHOVETA - `SARDINA COMUN` - JUREL,
Anchoveta = ANCHOVETA,
Sardine = `SARDINA COMUN`,
JackMackerel = JUREL
) %>%
select(COD_BARCO, TIPO_FLOTA, Anchoveta, Sardine, JackMackerel, Other)
# Strategy function
get_strategy <- function(sardine, jackmackerel, anchoveta, other) {
species <- c()
if (sardine > 0.15) species <- c(species, "Sardine")
if (jackmackerel > 0.15) species <- c(species, "JackMackerel")
if (anchoveta > 0.15) species <- c(species, "Anchoveta")
if (other > 0.15) species <- c(species, "Other")
n <- length(species)
if (n == 0) return("None or negligible")
if (n == 1) return(paste("Only", species[1]))
if (n == 2) return(paste0(species[1], " and ", species[2]))
if (n == 3) return(paste0(species[1], ", ", species[2], " and ", species[3]))
return(paste0(species, collapse = ", "))
}
# Apply strategy classification
vessel_species_year <- vessel_species_year %>%
mutate(strategy_After = pmap_chr(
list(Sardine, JackMackerel, Anchoveta, Other),
get_strategy
))
# Percentages by fleet type
strategy_percent <- vessel_species_year %>%
group_by(TIPO_FLOTA, strategy_After) %>%
summarise(n = n(), .groups = "drop") %>%
group_by(TIPO_FLOTA) %>%
mutate(percent = round(100 * n / sum(n), 1)) %>%
arrange(TIPO_FLOTA, desc(percent))
# Final table vessel-strategy
strategy_after <- vessel_species_year %>%
select(COD_BARCO, TIPO_FLOTA, strategy_After)
# Build shares per vessel/fleet/year/species
vessel_species_year <- logbooks %>%
filter(year < 2019) %>%
select(COD_BARCO, TIPO_FLOTA, year, NOMBRE_ESPECIE, CAPTURA_RETENIDA) %>%
group_by(COD_BARCO, TIPO_FLOTA, year, NOMBRE_ESPECIE) %>%
summarise(total_catch = sum(CAPTURA_RETENIDA, na.rm = TRUE), .groups = "drop") %>%
group_by(COD_BARCO, TIPO_FLOTA, year) %>%
mutate(species_share = total_catch / sum(total_catch, na.rm = TRUE)) %>%
ungroup() %>%
select(-total_catch) %>%
complete(COD_BARCO, TIPO_FLOTA, year, NOMBRE_ESPECIE, fill = list(species_share = 0)) %>%
group_by(COD_BARCO, TIPO_FLOTA, year) %>%
filter(sum(species_share, na.rm = TRUE) > 0) %>%
group_by(COD_BARCO, TIPO_FLOTA, NOMBRE_ESPECIE) %>%
summarise(species_share = mean(species_share, na.rm = TRUE), .groups = "drop") %>%
pivot_wider(
names_from = NOMBRE_ESPECIE,
values_from = species_share,
values_fill = 0
) %>%
# here just add missing columns if they don't exist
{ if(!"ANCHOVETA" %in% names(.)) .$ANCHOVETA <- 0; . } %>%
{ if(!"SARDINA COMUN" %in% names(.)) .$`SARDINA COMUN` <- 0; . } %>%
{ if(!"JUREL" %in% names(.)) .$JUREL <- 0; . } %>%
mutate(
Other = 1 - ANCHOVETA - `SARDINA COMUN` - JUREL,
Anchoveta = ANCHOVETA,
Sardine = `SARDINA COMUN`,
JackMackerel = JUREL
) %>%
select(COD_BARCO, TIPO_FLOTA, Anchoveta, Sardine, JackMackerel, Other)
# Apply strategy classification
vessel_species_year <- vessel_species_year %>%
mutate(strategy_Before = pmap_chr(
list(Sardine, JackMackerel, Anchoveta, Other),
get_strategy
))
# Percentages by fleet type
strategy_percent_before <- vessel_species_year %>%
group_by(TIPO_FLOTA, strategy_Before) %>%
summarise(n = n(), .groups = "drop") %>%
group_by(TIPO_FLOTA) %>%
mutate(percent = round(100 * n / sum(n), 1)) %>%
arrange(TIPO_FLOTA, desc(percent))
# Final table vessel-strategy
strategy_before <- vessel_species_year %>%
select(COD_BARCO, TIPO_FLOTA, strategy_Before)
rm(vessel_species_year)
library(kableExtra)
library(stringr)
# Rename for joining
before <- strategy_percent_before %>%
rename(strategy = strategy_Before, n_before = n, percent_before = percent)
after <- strategy_percent %>%
rename(strategy = strategy_After, n_after = n, percent_after = percent)
# Merge strategies
strategy_summary <- full_join(before, after, by = c("strategy", "TIPO_FLOTA")) %>%
arrange(desc(coalesce(percent_after, 0) + coalesce(percent_before, 0))) %>%
mutate(across(where(is.numeric), ~replace_na(., 0)))
# Filter only ART
strategy_table_art <- strategy_summary %>%
filter(TIPO_FLOTA == "ART") %>%
ungroup() %>%
select(-TIPO_FLOTA)
# Create table with grouped columns
strategy_table_art %>%
select(strategy, n_before, percent_before, n_after, percent_after) %>%
kable("latex", booktabs = TRUE, digits = 1,
col.names = c("Strategy", "n", "%", "n", "%"),
caption = "Comparison of Strategies Before and After -- Small-scale vessels") %>%
add_header_above(c(" " = 1, "Before" = 2, "After" = 2)) %>%
kable_styling(font_size = 10)
rm(strategy_table_art)
library(kableExtra)
library(stringr)
# Rename for joining
before <- strategy_percent_before %>%
rename(strategy = strategy_Before, n_before = n, percent_before = percent)
after <- strategy_percent %>%
rename(strategy = strategy_After, n_after = n, percent_after = percent)
# Merge strategies
strategy_summary <- full_join(before, after, by = c("strategy", "TIPO_FLOTA")) %>%
arrange(desc(coalesce(percent_after, 0) + coalesce(percent_before, 0))) %>%
mutate(across(where(is.numeric), ~replace_na(., 0)))
# Filter only IND
strategy_table_ind <- strategy_summary %>%
filter(TIPO_FLOTA == "IND") %>%
ungroup() %>%
select(-TIPO_FLOTA)
rm(strategy_summary, strategy_percent, strategy_percent_before, after, before)
# Create table with grouped columns
strategy_table_ind %>%
select(strategy, n_before, percent_before, n_after, percent_after) %>%
kable("latex", booktabs = TRUE, digits = 1,
col.names = c("Strategy", "n", "%", "n", "%"),
caption = "Comparison of Strategies Before and After -- Industrial vessels") %>%
add_header_above(c(" " = 1, "Before" = 2, "After" = 2)) %>%
kable_styling(font_size = 10)
rm(strategy_table_ind)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggalluvial)
library(patchwork)
library(ggrepel)
strategy_transitions <- full_join(strategy_before, strategy_after, by = c("COD_BARCO", "TIPO_FLOTA")) %>%
mutate(
strategy_Before = ifelse(is.na(strategy_Before), "No fishing", strategy_Before),
strategy_After  = ifelse(is.na(strategy_After),  "No fishing", strategy_After)
) %>% filter(TIPO_FLOTA == "ART")
transition_counts <- strategy_transitions %>%
count(strategy_Before, strategy_After)
simplify_focus_strategy <- function(strategy) {
ifelse(strategy == "Only Sardine", "Sardine",
ifelse(strategy == "Only Anchoveta", "Anchoveta",
ifelse(strategy == "Only JackMackerel", "JackMackerel",
ifelse(grepl("Sardine", strategy) & grepl("Anchoveta", strategy) & grepl("JackMackerel", strategy),
"Sardine, JackMackerel & Anchoveta",
ifelse(grepl("Sardine", strategy) & grepl("Anchoveta", strategy), "Sardine & Anchoveta",
ifelse(grepl("Sardine", strategy) & grepl("JackMackerel", strategy), "Sardine & JackMackerel",
ifelse(grepl("JackMackerel", strategy) & grepl("Anchoveta", strategy), "JackMackerel & Anchoveta",
ifelse(strategy == "No fishing", "No fishing", "Other"))))))))
}
strategy_transitions_focus <- strategy_transitions %>%
mutate(
strategy_Before_simple = simplify_focus_strategy(strategy_Before),
strategy_After_simple = simplify_focus_strategy(strategy_After)
)
# %>%
#   filter(strategy_Before_simple %in% c("Sardine", "Anchoveta", "Sardine & Anchoveta", "Sardine & JackMackerel", "JackMackerel & Anchoveta", "Sardine, JackMackerel & Anchoveta","No fishing") |
#            strategy_After_simple %in% c("Sardine", "Anchoveta", "Sardine & Anchoveta", "Sardine & JackMackerel", "JackMackerel & Anchoveta", "Sardine, JackMackerel & Anchoveta","No fishing"))
transition_counts_focus <- strategy_transitions_focus %>%
count(strategy_Before_simple, strategy_After_simple)
# Base plot
p <- ggplot(transition_counts_focus,
aes(axis1 = strategy_Before_simple,
axis2 = strategy_After_simple,
y = n)) +
geom_flow(aes(fill = strategy_Before_simple),
width = 1/12, knot.pos = 0.4, alpha = 0.8) +
geom_stratum(width = 1/12, fill = "gray95", color = "black") +
scale_x_discrete(limits = c("2012–2018", "2019–2024"),
expand = c(.25, .25)) +
scale_fill_brewer(type = "qual", palette = "Set2") +
labs(x = "", y = "Number of Vessels") +
theme_minimal(base_size = 12) +
theme(
legend.position = "none",
panel.grid = element_blank()
)
# Extraer posiciones de etiquetas
stratum_data <- ggplot_build(p)$data[[2]]
left_labels <- stratum_data %>%
filter(x == 1) %>%
mutate(x = x - 0.05,
stratum = str_wrap(stratum, width = 20))
right_labels <- stratum_data %>%
filter(x == 2) %>%
mutate(x = x + 0.05,
stratum = str_wrap(stratum, width = 20))
# Agregar etiquetas con repel
p <- p +
geom_text_repel(
data = left_labels,
aes(x = x, y = y, label = stratum),
inherit.aes = FALSE,
hjust = 1, nudge_x = -0.1, direction = "y",
size = 2.5, segment.color = "grey60", segment.size = 0.3
) +
geom_text_repel(
data = right_labels,
aes(x = x, y = y, label = stratum),
inherit.aes = FALSE,
hjust = 0, nudge_x = 0.1, direction = "y",
size = 2.5, segment.color = "grey60", segment.size = 0.3
)
p
ggsave("figs/strategy_transitions_ART.svg", p,
device = svglite::svglite, width = 10, height = 6, units = "in")
View(strategy_before)
View(strategy_after)
strategy_transitions <- full_join(strategy_before, strategy_after, by = c("COD_BARCO", "TIPO_FLOTA")) %>%
mutate(
strategy_Before = ifelse(is.na(strategy_Before), "No fishing", strategy_Before),
strategy_After  = ifelse(is.na(strategy_After),  "No fishing", strategy_After)
) %>% filter(TIPO_FLOTA == "IND")
View(strategy_transitions)
transition_counts <- strategy_transitions %>%
count(strategy_Before, strategy_After)
View(transition_counts)
simplify_focus_strategy <- function(strategy) {
ifelse(strategy == "Only Sardine", "Sardine",
ifelse(strategy == "Only Anchoveta", "Anchoveta",
ifelse(strategy == "Only JackMackerel", "JackMackerel",
ifelse(grepl("Sardine", strategy) & grepl("Anchoveta", strategy) & grepl("JackMackerel", strategy),
"Sardine, JackMackerel & Anchoveta",
ifelse(grepl("Sardine", strategy) & grepl("Anchoveta", strategy), "Sardine & Anchoveta",
ifelse(grepl("Sardine", strategy) & grepl("JackMackerel", strategy), "Sardine & JackMackerel",
ifelse(grepl("JackMackerel", strategy) & grepl("Anchoveta", strategy), "JackMackerel & Anchoveta",
ifelse(strategy == "No fishing", "No fishing", "Other"))))))))
}
strategy_transitions_focus <- strategy_transitions %>%
mutate(
strategy_Before_simple = simplify_focus_strategy(strategy_Before),
strategy_After_simple = simplify_focus_strategy(strategy_After)
)
# %>%
#   filter(strategy_Before_simple %in% c("Sardine", "Anchoveta", "Sardine & Anchoveta", "Sardine & JackMackerel", "JackMackerel & Anchoveta", "Sardine, JackMackerel & Anchoveta","No fishing") |
#            strategy_After_simple %in% c("Sardine", "Anchoveta", "Sardine & Anchoveta", "Sardine & JackMackerel", "JackMackerel & Anchoveta", "Sardine, JackMackerel & Anchoveta","No fishing"))# %>%
#   filter(strategy_Before_simple %in% c("Sardine", "Anchoveta", "Sardine & Anchoveta", "Sardine & JackMackerel", "JackMackerel & Anchoveta", "Sardine, JackMackerel & Anchoveta","No fishing") |
#            strategy_After_simple %in% c("Sardine", "Anchoveta", "Sardine & Anchoveta", "Sardine & JackMackerel", "JackMackerel & Anchoveta", "Sardine, JackMackerel & Anchoveta","No fishing"))
transition_counts_focus <- strategy_transitions_focus %>%
count(strategy_Before_simple, strategy_After_simple)
View(strategy_transitions_focus)
ggplot(transition_counts_focus,
aes(axis1 = strategy_Before_simple,
axis2 = strategy_After_simple,
y = n)) +
geom_flow(aes(fill = strategy_Before_simple),
width = 1/12, knot.pos = 0.4, alpha = 0.8)
ggplot(transition_counts_focus,
aes(axis1 = strategy_Before_simple,
axis2 = strategy_After_simple,
y = n)) +
geom_flow(aes(fill = strategy_Before_simple),
width = 1/12, knot.pos = 0.4, alpha = 0.8) +
geom_stratum(width = 1/12, fill = "gray95", color = "black")
ggplot(transition_counts_focus,
aes(axis1 = strategy_Before_simple,
axis2 = strategy_After_simple,
y = n)) +
geom_flow(aes(fill = strategy_Before_simple),
width = 1/12, knot.pos = 0.4, alpha = 0.8) +
geom_stratum(width = 1/12, fill = "gray95", color = "black")  +
scale_x_discrete(limits = c("2012–2018", "2019–2024"),
expand = c(.25, .25)) +
scale_fill_brewer(type = "qual", palette = "Set2") +
labs(x = "", y = "Number of Vessels") +
theme_minimal(base_size = 12) +
theme(
legend.position = "none",
panel.grid = element_blank()
)
vessel_species_year <- logbooks %>%
filter(year >= 2019) %>%
select(COD_BARCO, TIPO_FLOTA, year, NOMBRE_ESPECIE, CAPTURA_RETENIDA) %>%
group_by(COD_BARCO, TIPO_FLOTA, year, NOMBRE_ESPECIE) %>%
summarise(total_catch = sum(CAPTURA_RETENIDA, na.rm = TRUE), .groups = "drop") %>%
group_by(COD_BARCO, TIPO_FLOTA, year) %>%
mutate(species_share = total_catch / sum(total_catch, na.rm = TRUE)) %>%
ungroup() %>%
select(-total_catch) %>%
complete(COD_BARCO, TIPO_FLOTA, year, NOMBRE_ESPECIE, fill = list(species_share = 0)) %>%
group_by(COD_BARCO, TIPO_FLOTA, year) %>%
filter(sum(species_share, na.rm = TRUE) > 0) %>%
group_by(COD_BARCO, TIPO_FLOTA, NOMBRE_ESPECIE) %>%
summarise(species_share = mean(species_share, na.rm = TRUE), .groups = "drop") %>%
pivot_wider(
names_from = NOMBRE_ESPECIE,
values_from = species_share,
values_fill = 0
) %>%
# here just add missing columns if they don't exist
{ if(!"ANCHOVETA" %in% names(.)) .$ANCHOVETA <- 0; . } %>%
{ if(!"SARDINA COMUN" %in% names(.)) .$`SARDINA COMUN` <- 0; . } %>%
{ if(!"JUREL" %in% names(.)) .$JUREL <- 0; . } %>%
mutate(
Other = 1 - ANCHOVETA - `SARDINA COMUN` - JUREL,
Anchoveta = ANCHOVETA,
Sardine = `SARDINA COMUN`,
JackMackerel = JUREL
) %>%
select(COD_BARCO, TIPO_FLOTA, Anchoveta, Sardine, JackMackerel, Other)
View(vessel_species_year)
View(vessel_species_year)
detach("package:base", unload = TRUE)
