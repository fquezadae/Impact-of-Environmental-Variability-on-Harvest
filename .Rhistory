names(beta0) <- "(Intercept)"
# vector completo
beta_full <- lm_obj$coefficients
beta_full["(Intercept)"] <- beta0
beta_full[names(beta)] <- beta
# ✔ reemplazo correcto
lm_obj$coefficients <- beta_full
return(lm_obj)
}
lm_sard <- patch_lm_with_lavaan(lm_sard, eq_sard)
lm_anch <- patch_lm_with_lavaan(lm_anch, eq_anch)
lm_jack <- patch_lm_with_lavaan(lm_jack, eq_jack)
## 5. Construir vectores de SE robustas (MLR) para cada eq ------
make_se_vec <- function(lm_obj, eq_obj) {
# SE de slopes
se_beta    <- eq_obj$reg$se
names(se_beta) <- eq_obj$reg$rhs
# SE de intercepto
se_beta0      <- eq_obj$int$se
names(se_beta0) <- "(Intercept)"
se_full <- rep(NA_real_, length(coef(lm_obj)))
names(se_full) <- names(coef(lm_obj))
se_full["(Intercept)"] <- se_beta0
se_full[names(se_beta)] <- se_beta
se_full
}
se_sard <- make_se_vec(lm_sard, eq_sard)
se_anch <- make_se_vec(lm_anch, eq_anch)
se_jack <- make_se_vec(lm_jack, eq_jack)
cat("\\begin{table}[!htbp]\n")
cat("\\centering\n")
cat("\\caption{Seemingly Unrelated Regression (SUR) estimates of biomass dynamics}\n")
cat("\\label{tab:SUR_results}\n")
stargazer(
lm_sard, lm_anch, lm_jack,
type = "latex",
header = FALSE,
float = FALSE,              # prevents stargazer from creating a duplicate table env
title = "",
label = "",
column.labels = c("Sardine", "Anchovy", "Jack mackerel"),
column.separate = c(1, 1, 1),
dep.var.labels = "Biomass (t+1)",
dep.var.caption = "",
dep.var.labels.include = FALSE,
covariate.labels = c(
"Sardine biomass (t)",
"Sardine biomass (t)$^2$",
"Anchovy biomass (t)",
"Anchovy biomass (t)$^2$",
"Jack mackerel biomass (t)",
"Jack mackerel biomass (t)$^2$",
"SST",
"SST$^2$",
"Chlorophyll-a",
"Chlorophyll-a$^2$",
"Sardine × Anchovy",
"Sardine × Jack mackerel",
"Anchovy × Jack mackerel",
"Constant"
),
se = list(se_sard, se_anch, se_jack),
digits = 3,
single.row = TRUE,
omit.stat = c("f"),
no.space = TRUE,
font.size = "footnotesize",
notes = "*$p<0.1$; **$p<0.05$; ***$p<0.01$. Robust standard errors in parenthesis.",
notes.append = FALSE
)
cat("\\end{table}\n")
View(logbooks)
str(logbooks)
log_spf <- logbooks %>%
filter(COD_ESPECIE %in% spf_codes) %>%
mutate(
year = year(FECHA_HORA_ZARPE),
trip_id = str_c(
COD_BARCO, "_",
format(FECHA_HORA_ZARPE, "%Y%m%d%H%M%S"), "_",
format(FECHA_HORA_RECALADA, "%Y%m%d%H%M%S")
)
)
spf_codes <- c(26, 33, 114)
log_spf <- logbooks %>%
filter(COD_ESPECIE %in% spf_codes) %>%
mutate(
year = year(FECHA_HORA_ZARPE),
trip_id = str_c(
COD_BARCO, "_",
format(FECHA_HORA_ZARPE, "%Y%m%d%H%M%S"), "_",
format(FECHA_HORA_RECALADA, "%Y%m%d%H%M%S")
)
)
View(log_spf)
trip_species <- log_spf %>%
group_by(COD_BARCO, TIPO_FLOTA, TIPO_EMB, year, trip_id, COD_ESPECIE, NOMBRE_ESPECIE) %>%
summarise(
land_kg = sum(CAPTURA_RETENIDA, na.rm = TRUE),
bodega = first(CAPACIDAD_BODEGA),
.groups = "drop"
)
View(trip_species)
sp_map <- tibble::tibble(
COD_ESPECIE = c(26, 28),          # <-- agrega aquí anchoveta/sardina
sp = c("jack", "mackerel")        # "jack"=jurel, "mackerel"=caballa (ejemplo)
)
sp_map <- tibble::tibble(
COD_ESPECIE = c(26, 33, 114),
sp = c("jack", "sardine", "anchoveta")
)
View(sp_map)
trip_wide <- trip_species %>%
left_join(sp_map, by = "COD_ESPECIE") %>%
filter(!is.na(sp)) %>%
select(COD_BARCO, TIPO_FLOTA, TIPO_EMB, year, trip_id, sp, land_kg) %>%
tidyr::pivot_wider(
names_from = sp,
values_from = land_kg,
values_fill = 0
)
View(trip_wide)
log_spf <- logbooks %>%
filter(COD_ESPECIE %in% spf_codes) %>%
mutate(
year = year(FECHA_HORA_ZARPE),
trip_id = str_c(
COD_BARCO, "_",
format(FECHA_HORA_ZARPE, "%Y%m%d%H%M%S"), "_",
format(FECHA_HORA_RECALADA, "%Y%m%d%H%M%S")
)
)
# Captura por viaje y especie (sumando lances dentro del viaje)
trip_species <- log_spf %>%
group_by(COD_BARCO, TIPO_FLOTA, TIPO_EMB, year, trip_id, COD_ESPECIE, NOMBRE_ESPECIE) %>%
summarise(
land_kg = sum(CAPTURA_RETENIDA, na.rm = TRUE),
bodega = first(CAPACIDAD_BODEGA),
.groups = "drop"
)
# Diccionario: ajusta nombres y códigos
sp_map <- tibble::tibble(
COD_ESPECIE = c(26, 33, 114),
sp = c("jackmackerel", "sardine", "anchoveta")
)
trip_wide <- trip_species %>%
left_join(sp_map, by = "COD_ESPECIE") %>%
filter(!is.na(sp)) %>%
select(COD_BARCO, TIPO_FLOTA, TIPO_EMB, year, trip_id, sp, land_kg) %>%
tidyr::pivot_wider(
names_from = sp,
values_from = land_kg,
values_fill = 0
)
# Panel anual: viajes y desembarques anuales por especie
panel_annual <- trip_wide %>%
group_by(COD_BARCO, TIPO_FLOTA, TIPO_EMB, year) %>%
summarise(
trips = n_distinct(trip_id),
land_jack = sum(jackmackerel, na.rm = TRUE),
land_anch = sum(anchoveta, na.rm = TRUE),
land_sard = sum(sardine, na.rm = TRUE),
.groups = "drop"
)
View(panel_annual)
summary(panel_annual$trips)
View(panel_annual)
log_spf %>%
count(trip_id) %>%
summarise(min = min(n), p50 = median(n), p95 = quantile(n, .95), max = max(n))
log_spf %>%
count(trip_id) %>%
summarise(min = min(n), p50 = median(n), p95 = quantile(n, .95), max = max(n))
log_spf %>%
group_by(trip_id) %>%
summarise(
tot_from_species = sum(CAPTURA_RETENIDA, na.rm=TRUE),
tot_reported = first(CAPTURA_RETENIDA_TOTAL),
diff = tot_from_species - tot_reported
) %>%
summarise(mean_abs_diff = mean(abs(diff), na.rm=TRUE))
View(logbooks)
log_spf <- logbooks %>%
filter(COD_ESPECIE %in% spf_codes) %>%
arrange(COD_BARCO, FECHA_LANCE) %>%
group_by(COD_BARCO) %>%
mutate(
dt_hours = as.numeric(difftime(FECHA_LANCE,
lag(FECHA_LANCE),
units = "hours")),
new_trip = if_else(is.na(dt_hours) | dt_hours > gap_hours, 1L, 0L),
trip_seq = cumsum(new_trip),
trip_id = paste(COD_BARCO, trip_seq, sep = "_"),
year = year(FECHA_LANCE)
) %>%
ungroup()
gap_hours <- 24
log_spf <- logbooks %>%
filter(COD_ESPECIE %in% spf_codes) %>%
arrange(COD_BARCO, FECHA_LANCE) %>%
group_by(COD_BARCO) %>%
mutate(
dt_hours = as.numeric(difftime(FECHA_LANCE,
lag(FECHA_LANCE),
units = "hours")),
new_trip = if_else(is.na(dt_hours) | dt_hours > gap_hours, 1L, 0L),
trip_seq = cumsum(new_trip),
trip_id = paste(COD_BARCO, trip_seq, sep = "_"),
year = year(FECHA_LANCE)
) %>%
ungroup()
# Captura por viaje y especie (sumando lances dentro del viaje)
trip_species <- log_spf %>%
group_by(COD_BARCO, TIPO_FLOTA, TIPO_EMB, year, trip_id, COD_ESPECIE, NOMBRE_ESPECIE) %>%
summarise(
land_kg = sum(CAPTURA_RETENIDA, na.rm = TRUE),
bodega = first(CAPACIDAD_BODEGA),
.groups = "drop"
)
# Diccionario: ajusta nombres y códigos
sp_map <- tibble::tibble(
COD_ESPECIE = c(26, 33, 114),
sp = c("jackmackerel", "sardine", "anchoveta")
)
trip_wide <- trip_species %>%
left_join(sp_map, by = "COD_ESPECIE") %>%
filter(!is.na(sp)) %>%
select(COD_BARCO, TIPO_FLOTA, TIPO_EMB, year, trip_id, sp, land_kg) %>%
tidyr::pivot_wider(
names_from = sp,
values_from = land_kg,
values_fill = 0
)
# Panel anual: viajes y desembarques anuales por especie
panel_annual <- trip_wide %>%
group_by(COD_BARCO, TIPO_FLOTA, TIPO_EMB, year) %>%
summarise(
trips = n_distinct(trip_id),
land_jack = sum(jackmackerel, na.rm = TRUE),
land_anch = sum(anchoveta, na.rm = TRUE),
land_sard = sum(sardine, na.rm = TRUE),
.groups = "drop"
)
# Chequeos rapidos
log_spf %>%
count(trip_id) %>%
summarise(min = min(n), p50 = median(n), p95 = quantile(n, .95), max = max(n))
View(log_spf)
# Dfinir viajes
log_spf <- log_spf %>%
arrange(COD_BARCO, FECHA_HORA_ZARPE, FECHA_LANCE) %>%
group_by(COD_BARCO) %>%
mutate(
new_trip = if_else(NUMERO_LANCE_EX == 1, 1L, 0L),
trip_id  = cumsum(new_trip)
) %>%
ungroup()
log_spf %>%
count(trip_id) %>%
summarise(
min = min(n),
p50 = median(n),
p95 = quantile(n, .95),
max = max(n)
)
trips_vy <- log_spf %>%
distinct(COD_BARCO, year, trip_id) %>%
count(COD_BARCO, year, name = "T_vy")
View(trips_vy)
View(log_spf)
log_spf <- logbook %>%
arrange(COD_BARCO, FECHA_HORA_ZARPE, FECHA_LANCE) %>%
group_by(COD_BARCO) %>%
mutate(
new_trip = if_else(NUMERO_LANCE_EX == 1, 1L, 0L),
trip_id  = cumsum(new_trip)
) %>%
ungroup()
log_spf <- logbooks %>%
arrange(COD_BARCO, FECHA_HORA_ZARPE, FECHA_LANCE) %>%
group_by(COD_BARCO) %>%
mutate(
new_trip = if_else(NUMERO_LANCE_EX == 1, 1L, 0L),
trip_id  = cumsum(new_trip)
) %>%
ungroup()
View(log_spf)
log_spf <- logbooks %>%
arrange(COD_BARCO, FECHA_HORA_ZARPE, FECHA_LANCE) %>%
group_by(COD_BARCO) %>%
mutate(
new_trip = if_else(NUMERO_LANCE_EX == 1, 1L, 0L),
trip_id  = cumsum(new_trip)
) %>%
ungroup()
log_spf %>%
count(trip_id) %>%
summarise(
min = min(n),
p50 = median(n),
p95 = quantile(n, .95),
max = max(n)
)
log_spf <- logbooks %>%
arrange(COD_BARCO, FECHA_HORA_ZARPE, FECHA_LANCE) %>%
group_by(COD_BARCO) %>%
mutate(
new_trip = (NUMERO_LANCE_EX == 1),
trip_seq = cumsum(new_trip)
) %>%
ungroup() %>%
mutate(
trip_id = paste(COD_BARCO, trip_seq, sep = "_")
)
log_spf %>%
count(trip_id) %>%
summarise(
min = min(n),
p50 = median(n),
p95 = quantile(n, .95),
max = max(n)
)
tab(logbooks$NUMERO_LANCE_EX)
tabulate(logbooks$NUMERO_LANCE_EX)
summarise(logbooks$NUMERO_LANCE_EX)
table(log_spf$NUMERO_LANCE_EX, useNA = "ifany")
log_spf %>%
count(NUMERO_LANCE_EX) %>%
arrange(NUMERO_LANCE_EX)
log_spf <- logbooks %>%
arrange(COD_BARCO, FECHA_HORA_ZARPE, FECHA_LANCE) %>%
group_by(COD_BARCO) %>%
mutate(
new_trip = case_when(
NUMERO_LANCE_EX == 1 ~ 1L,
is.na(lag(FECHA_HORA_ZARPE)) ~ 1L,
FECHA_HORA_ZARPE != lag(FECHA_HORA_ZARPE) ~ 1L,
TRUE ~ 0L
),
trip_seq = cumsum(new_trip)
) %>%
ungroup() %>%
mutate(
trip_id = paste(COD_BARCO, trip_seq, sep = "_")
)
log_spf %>%
count(trip_id) %>%
summarise(
min = min(n),
p50 = median(n),
p95 = quantile(n, .95),
max = max(n)
)
# Viajes por barco–año
trips_vy <- log_spf %>%
distinct(COD_BARCO, year, trip_id) %>%
count(COD_BARCO, year, name = "T_vy")
View(trips_vy)
trips_vy %>%
summarise(
min = min(T_vy),
p50 = median(T_vy),
p95 = quantile(T_vy, .95),
max = max(T_vy)
)
vessel_chars <- log_spf %>%
distinct(
COD_BARCO,
TIPO_FLOTA,        # IND / ART
TIPO_EMB,          # PAM, etc.
CAPACIDAD_BODEGA
)
View(vessel_chars)
mean(trips_vy$T_vy)
var(trips_vy$T_vy)
Mode <- function(x) {
ux <- na.omit(unique(x))
ux[which.max(tabulate(match(x, ux)))]
}
vessel_chars <- log_spf %>%
group_by(COD_BARCO) %>%
summarise(
TIPO_FLOTA        = Mode(TIPO_FLOTA),
TIPO_EMB          = Mode(TIPO_EMB),
CAPACIDAD_BODEGA  = Mode(CAPACIDAD_BODEGA),
.groups = "drop"
)
log_spf %>%
group_by(COD_BARCO) %>%
summarise(
n_tipo_emb = n_distinct(TIPO_EMB),
n_bodega   = n_distinct(CAPACIDAD_BODEGA)
) %>%
summarise(
pct_mult_emb = mean(n_tipo_emb > 1),
pct_mult_bod = mean(n_bodega   > 1)
)
log_spf %>%
group_by(COD_BARCO) %>%
count(TIPO_EMB) %>%
mutate(share = n / sum(n)) %>%
summarise(
max_share = max(share)
) %>%
summarise(
p50 = median(max_share),
p10 = quantile(max_share, .10)
)
Mode <- function(x) {
ux <- na.omit(unique(x))
ux[which.max(tabulate(match(x, ux)))]
}
vessel_chars <- log_spf %>%
group_by(COD_BARCO) %>%
summarise(
TIPO_FLOTA        = Mode(TIPO_FLOTA),
TIPO_EMB          = Mode(TIPO_EMB),
CAPACIDAD_BODEGA  = Mode(CAPACIDAD_BODEGA),
.groups = "drop"
)
View(vessel_chars)
Mode <- function(x) {
x <- x[!is.na(x)]
if (length(x) == 0) return(NA)
ux <- unique(x)
ux[which.max(tabulate(match(x, ux)))]
}
vessel_chars <- log_spf %>%
group_by(COD_BARCO) %>%
summarise(
TIPO_FLOTA        = Mode(TIPO_FLOTA),
TIPO_EMB          = Mode(TIPO_EMB),
CAPACIDAD_BODEGA  = Mode(CAPACIDAD_BODEGA),
.groups = "drop"
)
View(vessel_chars)
vessel_chars %>%
summarise(
pct_na_tipo = mean(is.na(TIPO_EMB)),
pct_na_bod  = mean(is.na(CAPACIDAD_BODEGA))
)
# CAPACIDAD_BODEGA (agrupada en bins)
log_spf %>%
mutate(bodega_bin = cut(
CAPACIDAD_BODEGA,
breaks = c(0, 200, 500, 1000, 1500, 2000, Inf),
right = FALSE
)) %>%
count(bodega_bin, sort = TRUE)
# TIPO_EMB por barco
vessel_chars %>%
count(TIPO_EMB, sort = TRUE) %>%
mutate(share = n / sum(n))
# TIPO_FLOTA por barco
vessel_chars %>%
count(TIPO_FLOTA, sort = TRUE) %>%
mutate(share = n / sum(n))
Mode <- function(x) {
x <- x[!is.na(x)]
if (length(x) == 0) return(NA)
ux <- unique(x)
ux[which.max(tabulate(match(x, ux)))]
}
log_spf <- log_spf %>%
mutate(
TIPO_EMB_clean = if_else(
TIPO_EMB %in% c("1", "2", "3"),
NA_character_,
TIPO_EMB
)
)
vessel_chars <- log_spf %>%
group_by(COD_BARCO) %>%
summarise(
TIPO_FLOTA = Mode(TIPO_FLOTA),
TIPO_EMB   = Mode(TIPO_EMB_clean),
CAPACIDAD_BODEGA = median(CAPACIDAD_BODEGA, na.rm = TRUE),
.groups = "drop"
)
# TIPO_EMB por barco
vessel_chars %>%
count(TIPO_EMB, sort = TRUE) %>%
mutate(share = n / sum(n))
# TIPO_FLOTA por barco
vessel_chars %>%
count(TIPO_FLOTA, sort = TRUE) %>%
mutate(share = n / sum(n))
vessel_chars <- vessel_chars %>%
mutate(
TIPO_EMB = replace_na(TIPO_EMB, "UNK")
)
View(vessel_chars)
poisson_df <- trips_vy %>%
left_join(vessel_chars, by = "COD_BARCO")
View(poisson_df)
library(MASS)
pois_ind <- glm.nb(
T_vy ~ CAPACIDAD_BODEGA +
TIPO_EMB,
data = poisson_df %>% filter(TIPO_FLOTA == "IND")
)
pois_art <- glm.nb(
T_vy ~ CAPACIDAD_BODEGA +
TIPO_EMB,
data = poisson_df %>% filter(TIPO_FLOTA == "ART")
)
View(pois_ind)
View(pois_art)
str(list(
notes1 = "Negative binomial models estimated separately by fleet segment.",
notes2 = "Allocated harvest is computed from historical vessel shares and aggregate TAC."
))
