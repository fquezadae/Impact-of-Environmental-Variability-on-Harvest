---
title: "The Impact of Environmental Variability on Fishers' Harvest Decisions in Chile
  using a Multi-Species Approach"
author: "Felipe J. Quezada-Escalona"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  bookdown::pdf_document2:
    latex_engine: xelatex
    number_sections: true
    toc: false
    pandoc_args: ["--variable=fontsize:11pt"]
  bookdown::latex_document2: default
bibliography: bibliography.bib
csl: apa.csl # Optional: for APA-style citations
linkcolor: blue
citecolor: blue
urlcolor: blue
link-citations: TRUE 
header-includes:
  - \usepackage{setspace}
  - \onehalfspacing
  - \usepackage{indentfirst}  # Enables first-line indentation
  - \setlength{\parindent}{10pt}  # Adjusts the indentation size
  - \usepackage{authblk}
  - \usepackage{booktabs}
  - \usepackage{caption}
  - \author{Felipe J. Quezada-Escalona}
  - \affil{Departmento de Economía \\ Universidad de Concepción \vspace{-48pt}}
editor_options: 
  markdown: 
    wrap: 72
abstract: "In this paper, we aim to answer how fishing decisions, aggregate catch levels, and the price of marine resources will be affected under different climatic scenarios in the multi-species small pelagic fishery (SPF) in Chile, composed by anchoveta (*Engraulis ringens*), jack mackerel (*Trachurus murphyi*), and sardine (*Strangomera bentincki*), among others. By doing this, we expect to gain a better understanding of how Chilean fishers and fishing communities will adapt to climate change. To address our research question, we will estimate a multi-species harvesting model. This model considers species' economic and biological interrelation to study the effect of climate variability on harvest decisions and substitution between species, and determine the impact of different climatic scenarios on the well-being (e.g., profits) of fishers and fishing communities in Chile. We hypothesize that when fishers have reduced access to a main target species, they will switch to the closest substitute if the expected revenue from targeting this new species exceeds the expected costs. Otherwise, the vessel would decrease fishing effort or even exit the fishery due to the lack of economically viable substitutes. Moreover, we expect that this behavior is heterogeneous depending on the geographical area of operation -- as it determines the availability of other species-- and the gear type used."
---

```{r directorio, message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls())
gc()

# Definir directorios según usuario

usuario <- Sys.info()[["user"]]
# computador <- Sys.info()[["nodename"]]  # Alternativamente puedes usar esto
if (usuario == "felip") {
  dirdata <- "C:/Users/felip/OneDrive - Universidad de Concepción/FONDECYT Iniciacion/Data/"
} else if (usuario == "FACEA") {
  dirdata <- "C:/Users/FACEA/OneDrive - Universidad de Concepción/FONDECYT Iniciacion/Data/"
} else {
  stop("Usuario no reconocido. Defina el directorio correspondiente.")
}
rm(usuario)

```

# Introduction

The distribution and abundance of marine resources are changing in response to environmental conditions such as global ocean warming [@Poloczanska2013-qq]. Climate change will shift species distribution in the future, leading to reduced species availability in some areas and increased availability in others. The literature that studies fishers’ responses to either changes in fish availability or policies that restrict access to fisheries [e.g., @Stafford2018-pq; @Vasquez_Caballero2023-ip] has identified that they can adopt the following adaptive strategies: (i) reduce or reallocate fishing effort, either to another species or to another location [@Gonzalez-Mon2021-kj]; (ii) continue following the same strategy; or (iii) exit the fishery and find alternative employment [@Powell2022-wj]. Among these strategies, reallocating effort to alternative species has been identified as a potentially effective response to climate change [@Young2018-kk]. Diversification of target species has also been linked to reduced income variability [e.g., @Kasperski2013-jz; @Sethi2014-bn] and greater resilience to both climate shocks [@Cline2017-dp; @Fisher2021-lw] and interannual oceanographic variability [@Aguilera2015-wo; @Finkbeiner2015-bs].

This emphasis on diversification aligns with broader evidence from food-producing sectors. As @sjcruz_jmp highlights, climate variability substantially affects agriculture and fisheries, where income depends heavily on environmental fluctuations (e.g., temperature, rainfall) and market forces (e.g., input costs) [@Kasperski2013-jz; @Carter2018]. With variability expected to reduce productivity, income risk is likely to rise [@Carter2018; @Free2019]. Diversification—whether within a sector (e.g., switching crops or species) or across sectors—is often promoted as an adaptive strategy [@Abbott2023-sb]. However, these strategies can be costly for resource-dependent communities with limited capital and skills [@Cherdchuchai2006; @Ellis2000], and the role of switching costs in shaping diversification remains poorly understood.

In the fisheries context, switching between species requires not only the skills but also the appropriate gear and permits [@Frawley2021-cw; @Powell2022-wj]. Even if these conditions are met, diversification may still be constrained by port infrastructure, markets, and regulations [@Beaudreau2019-xg; @Kasperski2013-jz; @Powell2022-wj]. Therefore, deciding which adaptation strategy to adopt is not straightforward and depends on multiple factors. Moreover, fishers may respond differently to similar circumstances depending on their goals, skills, and preferences [@Zhang2011-wv; @Jardine2020-um; @Powell2022-wj].

In this research, we aim to answer how fishing decisions, aggregate catch levels, and the price of marine resources will be affected under different climatic scenarios in the multi-species small pelagic fishery (SPF) in Chile, composed of anchoveta (*Engraulis ringens*), jack mackerel (*Trachurus murphyi*), sardine (*Strangomera bentincki*), among others. The SPF is the most important in terms of catches in the country, accounting for almost 94% of the total Chilean catch in 2019 [@SUBPESCA2020]. Through this research, we aim to gain a deeper understanding of how Chilean fishers and fishing communities will adapt to climate change. To address our research question, we will estimate a multi-species harvesting model based on @Kasperski2015-jm. This model considers species' economic and biological interrelations to study the effect of climate variability on harvest decisions and substitution between species, and to determine the impact of different climatic scenarios on the well-being (e.g., profits) of fishers and fishing communities in Chile. We expect to find significant effects of climate variables on species stock dynamics, the cost of fishing during a trip, and the number of trips a vessel takes. These environmental effects might influence optimal harvest levels and prices in local markets. <!-- We also expect to find significant interrelations between species stock and harvest, and that the composition of the catch will vary depending on the climate scenario we use for future -->
<!-- predictions. -->

Under a changing climate, studying the effect of climatic variability on fishers' harvest decisions and landings is relevant for understanding fishing communities' adaptive capacities and strategies in response to climate change, thereby enabling the design of potential mitigation measures in response to these changes by policymakers. Countries have different institutions, cultures, and norms, leading to differing responses based on the study's location. For this reason, conducting this research based on the Chilean fishing industry is necessary to develop local policies that aim to reduce climate change impacts on fisheries. While there is some literature on the effect of climate change on Chilean fisheries, I am unaware of local-level studies that consider a multiple-species framework and the interrelationship between the local market and fishing decisions seen under a variable climate context.[^1]

[^1]: For the case of Chile, as far as I know, the only article that studies fishers’ behavior using discrete choice modeling is @Pena-Torres2017-gn. This article studies how the El Niño–Southern Oscillation (ENSO) affects fishers’ location choices in the jack mackerel fishery.

Because predator–prey links couple these species, reductions in anchoveta or sardine availability may reflect not only environmental drivers but also changes in predation pressure from jack mackerel [@Alheit2004; @Arancibia2019-FIPA]. Thus, even fishers who do not target jack mackerel can face induced changes in catch rates and revenues through ecosystem feedbacks. We hypothesize that if the availability of a main target species decreases, fishers will switch to the closest substitute when expected revenues (net of switching costs) exceed expected costs; otherwise they may reduce effort or exit the fishery. We also expect cross-fleet spillovers: in Chile, jack mackerel is predominantly harvested by the industrial purse-seine fleet, whereas anchoveta and sardine have substantial artisanal and industrial participation. Shocks in one component can propagate across fleets via both biology and markets, in addition to economic linkages (bycatch constraints, shared gear, and market spillovers). This strengthens the case for a multi-species framework that models joint dynamics and substitution rather than single-species responses. Moreover, we expect that this behavior is heterogeneous depending on the geographical area of operation—as it determines the availability of other species [@Reimer2017-jw]—and the gear type used.





# SPF in Chile

The small pelagic fishery (SPF) in Chile is of critical importance to the national fisheries sector. In 2019, the SPF represented nearly 94% of total national fish landings [@SUBPESCA2020]. The fishery is primarily composed of anchoveta (*Engraulis ringens*), sardine (*Strangomera bentincki*), and jack mackerel (*Trachurus murphyi*). While in the Northern region competition mainly occurs between anchoveta and jack mackerel, in the Central-South region all three species play a major role. This makes the Central-South particularly relevant for the study of species interactions and potential substitution within a multispecies management framework, and it is therefore the focus of this research.

  - Jack mackerel fishery was initially fished in northern chile. But, since the mid-1980s the main fishing grounds have been Central-south Chile [@Pena-Torres2017-gn] -- Traditionally within 50nm
  - Species have been historically used for fishmeal and fish oil production [@Pena-Torres2017-gn]... Jack Mackerel: 85% of total landings as a yearly average over the period 1987–2004).
  - 80 and 300 m$^3$ sardine and anchovy; More than 800 m$^3$, likely jack mackerel. @Pena-Torres2017-gn dummy for $H \leq 370 \ \text{m}^3$, $370 \ \text{m}^3 < H \leq 790 \ \text{m}^3$, $H > 790 \ \text{m}^3$ ... Also use age of vessel to check technical obsolescence (year trip, year ship was built)
  - Ports: San Antonio, Tome, Talcahuano, San Vicente, Coronel, Lota, Corral

## Status of the stocks
Historically, anchoveta in the Central-South was considered collapsed until 2018, shifted to overexploited status in 2019, and has since 2020 been fished within maximum sustainable yield (MSY) limits. Meanwhile, sardine stocks have generally remained within MSY levels, except in 2021 and 2023 when they were classified as overexploited. Jack mackerel was overexploited until 2018 but has since been harvested within MSY limits. 

## Quota allocation

The Chilean fishing sector is managed primarily through a Total Allowable Catch (TAC; *Cuota Global*), which is divided between the industrial and artisanal sectors. A small share (≈2%) is reserved for research, with additional portions allocated to contingency and human consumption. The TAC is subdivided by region and season, and unused quotas may be reassigned during the fishing year.

Anchoveta and sardine are regulated as a mixed-species fishery: although each has its own quota, substitution between them is permitted. A share of industrial quota is also periodically reassigned to the artisanal sector.

Since 2013, the industrial sector has operated under an individual transferable quota (ITQ) system, known as Transferable Fishing Licenses (*Licencias Transables de Pesca, LTP*). Class A licenses were allocated based on historical catches, while Class B licenses—up to 15% of the industrial fraction—are auctioned, with the first auctions held in 2015. These sealed-bid, first-price auctions aimed to broaden access and limit concentration but have faced challenges such as low participation, difficulties in reflecting economies of scale, and signs of potential coordinated bidding [@peña_torres_2022_MRE].

The artisanal TAC operates under a regulated freedom-to-fish regime, allowing registered vessels to fish without individual quotas, except in areas where access is closed or suspended, in which case authorities may implement management measures. The main measure is the Régimen Artesanal de Extracción (RAE), which allocates the regional artisanal TAC by area, vessel size, landing site (caleta), organization, or individually, in agreement with artisanal fisher organizations. To date, area-based and organization-based allocations are the only observed schemes. Area-based allocations allow registered artisanal vessels in a given area to fish as in open access until the assigned quota is exhausted, while organization-based allocations follow the historical rights of members to distribute the organization’s quota.


- Sardine: RAE in V, VIII Y X regions? What about other species? Open access in anchovy and jack mackerel (only artisanal TAC matter at country level?)



## Other regulations

### Limited entry

Fishery with restricted access to new operators (just artisanal?)


### Biological closures for recruitment

- Jack mackerel is open through all year.
- Sardine and anchovy: In southern-central Chile, December–April (fixed period: January to February).

### Biological closures for reproduction

- Jack mackerel is open through all year.
- Sardine and anchovy: In southern-central Chile, July–October (fixed period: August-September).

- Seasonality? Include quarter dummies? Jack mackerel gather in the first 6 month of the year in shoals, great density in EEZ, then migrate outside 200nm ()

### Minimum size

- Jack mackerel: 26 cm 
- Sardine and anchovy?

### Maximum harvest levels

- All species: Maximum catch limit per vessel owner (LMC) for industrial vessels


```{r load_env_vars, message=FALSE, warning=FALSE, include=FALSE}

env_dt <- readRDS("data/env/EnvCoastDaily_2012_2025_0.125deg.rds")

```


```{r load_biomass, message=FALSE, warning=FALSE, include=FALSE}

biomass <- readRDS("data/biomass/biomass_dt.rds")

```

```{r load_logbook, message=FALSE, warning=FALSE, include=FALSE}

logbooks <- readRDS("data/logbooks/logbooks.rds")

```

```{r harvest_substitution_after, message=FALSE, warning=FALSE, include=FALSE}

library(dplyr)
library(data.table)
library(lubridate)
library(sf)
library(rnaturalearth)
library(ggplot2)
library(tidyr)
library(purrr)

# Build shares per vessel/fleet/year/species
vessel_species_year <- logbooks %>%
  filter(year >= 2019) %>%
  select(COD_BARCO, TIPO_FLOTA, year, NOMBRE_ESPECIE, CAPTURA_RETENIDA) %>%
  group_by(COD_BARCO, TIPO_FLOTA, year, NOMBRE_ESPECIE) %>%
  summarise(total_catch = sum(CAPTURA_RETENIDA, na.rm = TRUE), .groups = "drop") %>%
  group_by(COD_BARCO, TIPO_FLOTA, year) %>%
  mutate(species_share = total_catch / sum(total_catch, na.rm = TRUE)) %>%
  ungroup() %>%
  select(-total_catch) %>%
  complete(COD_BARCO, TIPO_FLOTA, year, NOMBRE_ESPECIE, fill = list(species_share = 0)) %>%
  group_by(COD_BARCO, TIPO_FLOTA, year) %>%
  filter(sum(species_share, na.rm = TRUE) > 0) %>%
  group_by(COD_BARCO, TIPO_FLOTA, NOMBRE_ESPECIE) %>%
  summarise(species_share = mean(species_share, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(
    names_from = NOMBRE_ESPECIE,
    values_from = species_share,
    values_fill = 0
  ) %>%
  # here just add missing columns if they don't exist
  { if(!"ANCHOVETA" %in% names(.)) .$ANCHOVETA <- 0; . } %>%
  { if(!"SARDINA COMUN" %in% names(.)) .$`SARDINA COMUN` <- 0; . } %>%
  { if(!"JUREL" %in% names(.)) .$JUREL <- 0; . } %>%
  mutate(
    Other = 1 - ANCHOVETA - `SARDINA COMUN` - JUREL,
    Anchoveta = ANCHOVETA,
    Sardine = `SARDINA COMUN`,
    JackMackerel = JUREL
  ) %>%
  select(COD_BARCO, TIPO_FLOTA, Anchoveta, Sardine, JackMackerel, Other)

# Strategy function
get_strategy <- function(sardine, jackmackerel, anchoveta, other) {
  species <- c()
  if (sardine > 0.15) species <- c(species, "Sardine")
  if (jackmackerel > 0.15) species <- c(species, "JackMackerel")
  if (anchoveta > 0.15) species <- c(species, "Anchoveta")
  if (other > 0.15) species <- c(species, "Other")
  
  n <- length(species)
  if (n == 0) return("None or negligible")
  if (n == 1) return(paste("Only", species[1]))
  if (n == 2) return(paste0(species[1], " and ", species[2]))
  if (n == 3) return(paste0(species[1], ", ", species[2], " and ", species[3]))
  return(paste0(species, collapse = ", "))
}

# Apply strategy classification
vessel_species_year <- vessel_species_year %>%
  mutate(strategy_After = pmap_chr(
    list(Sardine, JackMackerel, Anchoveta, Other),
    get_strategy
  ))

# Percentages by fleet type
strategy_percent <- vessel_species_year %>%
  group_by(TIPO_FLOTA, strategy_After) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(TIPO_FLOTA) %>%
  mutate(percent = round(100 * n / sum(n), 1)) %>%
  arrange(TIPO_FLOTA, desc(percent))

# Final table vessel-strategy
strategy_after <- vessel_species_year %>%
  select(COD_BARCO, TIPO_FLOTA, strategy_After)

```

```{r harvest_substitution_before, message=FALSE, warning=FALSE, include=FALSE}

# Build shares per vessel/fleet/year/species
vessel_species_year <- logbooks %>%
  filter(year < 2019) %>%
  select(COD_BARCO, TIPO_FLOTA, year, NOMBRE_ESPECIE, CAPTURA_RETENIDA) %>%
  group_by(COD_BARCO, TIPO_FLOTA, year, NOMBRE_ESPECIE) %>%
  summarise(total_catch = sum(CAPTURA_RETENIDA, na.rm = TRUE), .groups = "drop") %>%
  group_by(COD_BARCO, TIPO_FLOTA, year) %>%
  mutate(species_share = total_catch / sum(total_catch, na.rm = TRUE)) %>%
  ungroup() %>%
  select(-total_catch) %>%
  complete(COD_BARCO, TIPO_FLOTA, year, NOMBRE_ESPECIE, fill = list(species_share = 0)) %>%
  group_by(COD_BARCO, TIPO_FLOTA, year) %>%
  filter(sum(species_share, na.rm = TRUE) > 0) %>%
  group_by(COD_BARCO, TIPO_FLOTA, NOMBRE_ESPECIE) %>%
  summarise(species_share = mean(species_share, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(
    names_from = NOMBRE_ESPECIE,
    values_from = species_share,
    values_fill = 0
  ) %>%
  # here just add missing columns if they don't exist
  { if(!"ANCHOVETA" %in% names(.)) .$ANCHOVETA <- 0; . } %>%
  { if(!"SARDINA COMUN" %in% names(.)) .$`SARDINA COMUN` <- 0; . } %>%
  { if(!"JUREL" %in% names(.)) .$JUREL <- 0; . } %>%
  mutate(
    Other = 1 - ANCHOVETA - `SARDINA COMUN` - JUREL,
    Anchoveta = ANCHOVETA,
    Sardine = `SARDINA COMUN`,
    JackMackerel = JUREL
  ) %>%
  select(COD_BARCO, TIPO_FLOTA, Anchoveta, Sardine, JackMackerel, Other)

# Apply strategy classification
vessel_species_year <- vessel_species_year %>%
  mutate(strategy_Before = pmap_chr(
    list(Sardine, JackMackerel, Anchoveta, Other),
    get_strategy
  ))

# Percentages by fleet type
strategy_percent_before <- vessel_species_year %>%
  group_by(TIPO_FLOTA, strategy_Before) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(TIPO_FLOTA) %>%
  mutate(percent = round(100 * n / sum(n), 1)) %>%
  arrange(TIPO_FLOTA, desc(percent))

# Final table vessel-strategy
strategy_before <- vessel_species_year %>%
  select(COD_BARCO, TIPO_FLOTA, strategy_Before)

```

See Figure \@ref(fig:switchStrategy-ART) for strategy transitions. The year 2019 is used as reference as anchoveta and jack mackerel started to recover.


```{r strategy_table_logbooks_ART, message=FALSE, warning=FALSE, include=FALSE, results='asis'}

library(kableExtra)
library(stringr)

# Rename for joining
before <- strategy_percent_before %>%
  rename(strategy = strategy_Before, n_before = n, percent_before = percent)

after <- strategy_percent %>%
  rename(strategy = strategy_After, n_after = n, percent_after = percent)

# Merge strategies
strategy_summary <- full_join(before, after, by = c("strategy", "TIPO_FLOTA")) %>%
  arrange(desc(coalesce(percent_after, 0) + coalesce(percent_before, 0))) %>%
  mutate(across(where(is.numeric), ~replace_na(., 0)))

# Filter only ART
strategy_table_art <- strategy_summary %>%
  filter(TIPO_FLOTA == "ART") %>%
  ungroup() %>%
  select(-TIPO_FLOTA)

```


Table \@ref(tab:table-art) for strategy transitions.


```{r table-art, echo=FALSE, results='asis'}

# Create table with grouped columns
strategy_table_art %>%
  select(strategy, n_before, percent_before, n_after, percent_after) %>%
  kable("latex", booktabs = TRUE, digits = 1,
        col.names = c("Strategy", "n", "%", "n", "%"),
        caption = "Comparison of Strategies Before and After -- Small-scale vessels") %>%
  add_header_above(c(" " = 1, "Before" = 2, "After" = 2)) %>%
  kable_styling(font_size = 10)

```


```{r strategy-table-logbooks_IND, message=FALSE, warning=FALSE, include=FALSE, results='asis'}

library(kableExtra)
library(stringr)

# Rename for joining
before <- strategy_percent_before %>%
  rename(strategy = strategy_Before, n_before = n, percent_before = percent)

after <- strategy_percent %>%
  rename(strategy = strategy_After, n_after = n, percent_after = percent)

# Merge strategies
strategy_summary <- full_join(before, after, by = c("strategy", "TIPO_FLOTA")) %>%
  arrange(desc(coalesce(percent_after, 0) + coalesce(percent_before, 0))) %>%
  mutate(across(where(is.numeric), ~replace_na(., 0)))

# Filter only IND
strategy_table_ind <- strategy_summary %>%
  filter(TIPO_FLOTA == "IND") %>%
  ungroup() %>%
  select(-TIPO_FLOTA)

```

Table \@ref(tab:table-ind) for industrial strategy transitions.


```{r table-ind, echo=FALSE, results='asis'}

# Create table with grouped columns
strategy_table_ind %>%
  select(strategy, n_before, percent_before, n_after, percent_after) %>%
  kable("latex", booktabs = TRUE, digits = 1,
        col.names = c("Strategy", "n", "%", "n", "%"),
        caption = "Comparison of Strategies Before and After -- Industrial vessels") %>%
  add_header_above(c(" " = 1, "Before" = 2, "After" = 2)) %>%
  kable_styling(font_size = 10)

```



```{r switchStrategy-ART, echo=FALSE, fig.height=6, fig.width=8, message=FALSE, warning=FALSE, results='asis', fig.cap='Strategy transitions for small-scale vessels'}

library(dplyr)
library(tidyr)
library(ggplot2)
library(ggalluvial)
library(patchwork)
library(ggrepel)

strategy_transitions <- full_join(strategy_before, strategy_after, by = c("COD_BARCO", "TIPO_FLOTA")) %>%
  mutate(
    strategy_Before = ifelse(is.na(strategy_Before), "No fishing", strategy_Before),
    strategy_After  = ifelse(is.na(strategy_After),  "No fishing", strategy_After)
  ) %>% filter(TIPO_FLOTA == "ART")

transition_counts <- strategy_transitions %>%
  count(strategy_Before, strategy_After)

simplify_focus_strategy <- function(strategy) {
  ifelse(strategy == "Only Sardine", "Sardine",
  ifelse(strategy == "Only Anchoveta", "Anchoveta",
  ifelse(strategy == "Only JackMackerel", "JackMackerel",
  ifelse(grepl("Sardine", strategy) & grepl("Anchoveta", strategy) & grepl("JackMackerel", strategy),
         "Sardine, JackMackerel & Anchoveta",
  ifelse(grepl("Sardine", strategy) & grepl("Anchoveta", strategy), "Sardine & Anchoveta",
  ifelse(grepl("Sardine", strategy) & grepl("JackMackerel", strategy), "Sardine & JackMackerel",
  ifelse(grepl("JackMackerel", strategy) & grepl("Anchoveta", strategy), "JackMackerel & Anchoveta",
  ifelse(strategy == "No fishing", "No fishing", "Other"))))))))
}

strategy_transitions_focus <- strategy_transitions %>%
  mutate(
    strategy_Before_simple = simplify_focus_strategy(strategy_Before),
    strategy_After_simple = simplify_focus_strategy(strategy_After)
  ) 

# %>%
#   filter(strategy_Before_simple %in% c("Sardine", "Anchoveta", "Sardine & Anchoveta", "Sardine & JackMackerel", "JackMackerel & Anchoveta", "Sardine, JackMackerel & Anchoveta","No fishing") |
#            strategy_After_simple %in% c("Sardine", "Anchoveta", "Sardine & Anchoveta", "Sardine & JackMackerel", "JackMackerel & Anchoveta", "Sardine, JackMackerel & Anchoveta","No fishing"))

transition_counts_focus <- strategy_transitions_focus %>%
  count(strategy_Before_simple, strategy_After_simple)


# Base plot
p <- ggplot(transition_counts_focus,
            aes(axis1 = strategy_Before_simple,
                axis2 = strategy_After_simple,
                y = n)) +
  geom_flow(aes(fill = strategy_Before_simple),
            width = 1/12, knot.pos = 0.4, alpha = 0.8) +
  geom_stratum(width = 1/12, fill = "gray95", color = "black") +
  scale_x_discrete(limits = c("2012–2018", "2019–2024"),
                   expand = c(.25, .25)) +
  scale_fill_brewer(type = "qual", palette = "Set2") +
  labs(x = "", y = "Number of Vessels") +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "none",
    panel.grid = element_blank()
  )

# Extraer posiciones de etiquetas
stratum_data <- ggplot_build(p)$data[[2]]

left_labels <- stratum_data %>%
  filter(x == 1) %>%
  mutate(x = x - 0.05,
         stratum = str_wrap(stratum, width = 20))

right_labels <- stratum_data %>%
  filter(x == 2) %>%
  mutate(x = x + 0.05,
         stratum = str_wrap(stratum, width = 20))

# Agregar etiquetas con repel
p +
  geom_text_repel(
    data = left_labels,
    aes(x = x, y = y, label = stratum),
    inherit.aes = FALSE,
    hjust = 1, nudge_x = -0.1, direction = "y",
    size = 2.5, segment.color = "grey60", segment.size = 0.3
  ) +
  geom_text_repel(
    data = right_labels,
    aes(x = x, y = y, label = stratum),
    inherit.aes = FALSE,
    hjust = 0, nudge_x = 0.1, direction = "y",
    size = 2.5, segment.color = "grey60", segment.size = 0.3
  )


```

```{r switchStrategy-IND, echo=FALSE, fig.height=6, fig.width=8, message=FALSE, warning=FALSE, results='asis', fig.cap='Strategy transitions for industrial vessels'}

library(dplyr)
library(tidyr)
library(ggplot2)
library(ggalluvial)
library(patchwork)
library(ggrepel)

strategy_transitions <- full_join(strategy_before, strategy_after, by = c("COD_BARCO", "TIPO_FLOTA")) %>%
  mutate(
    strategy_Before = ifelse(is.na(strategy_Before), "No fishing", strategy_Before),
    strategy_After  = ifelse(is.na(strategy_After),  "No fishing", strategy_After)
  ) %>% filter(TIPO_FLOTA == "IND")

transition_counts <- strategy_transitions %>%
  count(strategy_Before, strategy_After)

simplify_focus_strategy <- function(strategy) {
  ifelse(strategy == "Only Sardine", "Sardine",
  ifelse(strategy == "Only Anchoveta", "Anchoveta",
  ifelse(strategy == "Only JackMackerel", "JackMackerel",
  ifelse(grepl("Sardine", strategy) & grepl("Anchoveta", strategy) & grepl("JackMackerel", strategy),
         "Sardine, JackMackerel & Anchoveta",
  ifelse(grepl("Sardine", strategy) & grepl("Anchoveta", strategy), "Sardine & Anchoveta",
  ifelse(grepl("Sardine", strategy) & grepl("JackMackerel", strategy), "Sardine & JackMackerel",
  ifelse(grepl("JackMackerel", strategy) & grepl("Anchoveta", strategy), "JackMackerel & Anchoveta",
  ifelse(strategy == "No fishing", "No fishing", "Other"))))))))
}

strategy_transitions_focus <- strategy_transitions %>%
  mutate(
    strategy_Before_simple = simplify_focus_strategy(strategy_Before),
    strategy_After_simple = simplify_focus_strategy(strategy_After)
  ) 

# %>%
#   filter(strategy_Before_simple %in% c("Sardine", "Anchoveta", "Sardine & Anchoveta", "Sardine & JackMackerel", "JackMackerel & Anchoveta", "Sardine, JackMackerel & Anchoveta","No fishing") |
#            strategy_After_simple %in% c("Sardine", "Anchoveta", "Sardine & Anchoveta", "Sardine & JackMackerel", "JackMackerel & Anchoveta", "Sardine, JackMackerel & Anchoveta","No fishing"))# %>%
#   filter(strategy_Before_simple %in% c("Sardine", "Anchoveta", "Sardine & Anchoveta", "Sardine & JackMackerel", "JackMackerel & Anchoveta", "Sardine, JackMackerel & Anchoveta","No fishing") |
#            strategy_After_simple %in% c("Sardine", "Anchoveta", "Sardine & Anchoveta", "Sardine & JackMackerel", "JackMackerel & Anchoveta", "Sardine, JackMackerel & Anchoveta","No fishing"))

transition_counts_focus <- strategy_transitions_focus %>%
  count(strategy_Before_simple, strategy_After_simple)


# Base plot
p <- ggplot(transition_counts_focus,
            aes(axis1 = strategy_Before_simple,
                axis2 = strategy_After_simple,
                y = n)) +
  geom_flow(aes(fill = strategy_Before_simple),
            width = 1/12, knot.pos = 0.4, alpha = 0.8) +
  geom_stratum(width = 1/12, fill = "gray95", color = "black") +
  scale_x_discrete(limits = c("2012–2018", "2019–2024"),
                   expand = c(.25, .25)) +
  scale_fill_brewer(type = "qual", palette = "Set2") +
  labs(x = "", y = "Number of Vessels") +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "none",
    panel.grid = element_blank()
  )

# Extraer posiciones de etiquetas
stratum_data <- ggplot_build(p)$data[[2]]

left_labels <- stratum_data %>%
  filter(x == 1) %>%
  mutate(x = x - 0.05,
         stratum = str_wrap(stratum, width = 20))

right_labels <- stratum_data %>%
  filter(x == 2) %>%
  mutate(x = x + 0.05,
         stratum = str_wrap(stratum, width = 20))

# Agregar etiquetas con repel
p +
  geom_text_repel(
    data = left_labels,
    aes(x = x, y = y, label = stratum),
    inherit.aes = FALSE,
    hjust = 1, nudge_x = -0.1, direction = "y",
    size = 2.5, segment.color = "grey60", segment.size = 0.3
  ) +
  geom_text_repel(
    data = right_labels,
    aes(x = x, y = y, label = stratum),
    inherit.aes = FALSE,
    hjust = 0, nudge_x = 0.1, direction = "y",
    size = 2.5, segment.color = "grey60", segment.size = 0.3
  )


```


```{r harvest_data, message=FALSE, warning=FALSE, include=FALSE}

library(readxl)
library(dplyr)

harvest_IFOP_month <- readRDS("data/harvest/IFOP_month.rds") 
harvest_IFOP <- readRDS("data/harvest/IFOP.rds")
harvest_SERNAPESCA <- readRDS("data/harvest/sernapesca.rds")


#---- IFOP loogbook data ----

harvest_IFOP_logbooks <- logbooks %>% 
  filter(year >= 2012) %>%
  filter(REGION %in% c(5,6,7,8,9,10,14,16)) %>%
  group_by(NOMBRE_ESPECIE, year) %>%
  summarise(
    harvest_IFOP_loogbook_centrosur = sum(CAPTURA_RETENIDA, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  rename(specie = NOMBRE_ESPECIE) %>%
  mutate(harvest_IFOP_loogbook_centrosur = harvest_IFOP_loogbook_centrosur / 1000)


#---- Harvest data merged ---- 

harvest <- left_join(harvest_IFOP, harvest_SERNAPESCA, by = c("year", "specie"))
harvest <- left_join(harvest, harvest_IFOP_logbooks, by = c("year", "specie")) 

```

```{r season_SPF, eval=FALSE, fig.align='center', fig.cap="Fishery seasons", fig.pos='ht!', message=FALSE, warning=FALSE, include=FALSE}

months <- c("E", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D")

# Fishing periods
sardine_periods <- data.frame(
  start = c(1, 3,7,10),    
  end = c(3,7,10,12),      
  status = c("Closed", "Open", "Closed", "Open")
)

# Cruise brackets
cruise_brackets <- data.frame(
  cruise = c("1st Cruise (Summer)", "2nd Cruise (Fall)"),
  x_start = c(1, 3),   
  x_end = c(3, 6),      
  y = c(1.05, 1.05)       
)

# Plot with reduced white space
ggplot() +
  geom_segment(data = sardine_periods, aes(x = start, xend = end, y = 1, yend = 1, color = status), size = 4) +
  geom_segment(data = cruise_brackets, aes(x = x_start, xend = x_end, y = y, yend = y), size = 1) +
  geom_segment(data = cruise_brackets, aes(x = x_start, xend = x_start, y = y, yend = y - 0.05), size = 1) +
  geom_segment(data = cruise_brackets, aes(x = x_end, xend = x_end, y = y, yend = y - 0.05), size = 1) +
  geom_text(data = cruise_brackets, aes(x = (x_start + x_end) / 2, y = y + 0.05, label = cruise), size = 3.5) +
  scale_x_continuous(breaks = 1:12, labels = months, expand = c(0, 0)) +
  scale_y_continuous(limits = c(0.9, 1.3), breaks = 1, labels = " ", expand = c(0, 0)) +
  scale_color_manual(values = c("Open" = "green", "Closed" = "red")) +
    labs(x = "Month", y = NULL) +
  theme_minimal() + coord_cartesian(clip = "off") +
theme(
  plot.margin = margin(2, 2, 2, 2),  # very small margins (t, r, b, l)
  axis.title.x = element_text(margin = margin(t = 0)),  # reduce margin below x-axis label
  axis.text.x = element_text(margin = margin(t = 0)),   # reduce space below x-axis ticks
  plot.title = element_text(hjust = 0.5, margin = margin(b = 0))  # reduce margin above title
)

```

```{r monthlyharvest, echo=FALSE, fig.align='center', fig.cap="Average monthly landings by species (2012-2024; South-Central Chile) ", fig.pos='ht!', message=FALSE, warning=FALSE}

# Spanish to English month translation
month_translation <- c(
  "ene" = "jan", "feb" = "feb", "mar" = "mar", "abr" = "apr",
  "may" = "may", "jun" = "jun", "jul" = "jul", "ago" = "aug",
  "sept" = "sep", "oct" = "oct", "nov" = "nov", "dic" = "dec"
)

# English month order
month_order <- c("jan", "feb", "mar", "apr", "may", "jun",
                 "jul", "aug", "sep", "oct", "nov", "dec")

# Summarize by month and species
harvest_summary <- harvest_IFOP_month %>%
  mutate(month = recode(month, !!!month_translation)) %>%  # Translate to English
  group_by(month, specie) %>%  # Make sure your column is 'species'
  summarise(harvest = mean(total_harvest_IFOP_centrosur, na.rm = TRUE),
            .groups = "drop") %>%
  mutate(month = factor(month, levels = month_order)) %>%
  mutate(specie = recode(specie,
                         "ANCHOVETA" = "Anchoveta",
                         "SARDINA COMUN" = "Sardine",
                         "JUREL" = "Jack Mackerel")) 


# Plot with facets by species
ggplot(harvest_summary, aes(x = month, y = harvest, fill = specie)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ specie, scales = "free_y", ncol = 1) +
  labs(x = "Month", y = "Average Harvest (tons)", fill = "Specie") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Paired")


rm(harvest_summary)
rm(list = c("harvest_IFOP", "harvest_SERNAPESCA", "harvest_IFOP_logbooks"))

```

# Data and methodology


<!-- SEE HOW FAR VESSEL TRAVEL -- 80 longitud aprox... IM USING 165 nm -->
<!-- USE DIFFERENT LENGHT EQUATIONS? (INTEAD OF GEAR?) -->
<!-- Shift in spatial distribution of jack mackerel out of EEZ during El Niño events -->


To fulfill the project's objectives, and following @Kasperski2015-jm, the research entails five different stages: (i) estimating the annual stock dynamics of each species included in the model, (ii) estimating trip level cost functions, (iii) estimating total annual trips, (iv) estimate the inverse demand model for outputs (i.e., price responses to supply), and (v) conduct numerical optimization to examine how harvest and profits levels evolve over time. The numeral optimization uses estimated parameters from the previous four stages to conduct the optimization procedure.

## Data


-   **SOLICITADO A IFOP 2012-2024:**
    -   Stock abundance and vessel landings (annual by
        port/county/region/country and species)
    -   Data at the trip level ([IFOP data
        observatory?](ifop.dataobservatory.net)]).
    -   Ex-vessel prices (monthly or annual by
        port/county/region/country and species)

How different are SERNAPESCA and IFOP harvest data? (Figura
\@ref(fig:harvestsource))

```{r harvestsource, echo=FALSE, fig.align='center', fig.cap="Desembarques anuales (IFOP vs SERNAPESCA)", fig.pos='ht!', message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)

harvest_long <- harvest %>% 
  dplyr::select(c("specie", "year", 
                  "total_harvest_IFOP_centrosur",
                  "harvest_LANCHAS_IFOP_centrosur",
                  "harvest_BOTES_IFOP_centrosur",
                  "harvest_IND_IFOP_centrosur",
                  "total_harvest_all_SERNAPESCA_Centro_Sur",
                  "harvest_IFOP_loogbook_centrosur")) %>%
  pivot_longer(cols = c("total_harvest_IFOP_centrosur",
                        "harvest_LANCHAS_IFOP_centrosur",
                        "harvest_BOTES_IFOP_centrosur",
                        "harvest_IND_IFOP_centrosur",
                        "total_harvest_all_SERNAPESCA_Centro_Sur",
                        "harvest_IFOP_loogbook_centrosur"),
               names_to = "source", 
               values_to = "harvest") %>%
  mutate(source = recode(source,
                         "harvest_LANCHAS_IFOP_centrosur" = "Lanchas IFOP",
                         "harvest_BOTES_IFOP_centrosur" = "Botes IFOP",
                         "harvest_IND_IFOP_centrosur" = "Industrial IFOP",
                         "total_harvest_IFOP_centrosur" = "Total IFOP",
                         "total_harvest_all_SERNAPESCA_Centro_Sur" = "Total SERNAPESCA",
                         "harvest_IFOP_loogbook_centrosur" = "Total IFOP (logbooks)")) %>%
  filter(source %in% c("Total IFOP", "Total SERNAPESCA", "Total IFOP (logbooks)", "Lanchas IFOP", "Botes IFOP",
                       "Industrial IFOP"))

# Gráfico
ggplot(harvest_long, aes(x = year, y = harvest, color = source)) +
  geom_line(size = 1) +
  facet_wrap(~specie, scales = "free_y") +
  labs(x = "Año", 
       y = "Annual landings (tons)", 
       color = "Source") +
  theme_minimal() +
  theme(legend.position = "bottom") 

rm(harvest_long)

```

For the environmental covariates, we use data from the E.U. Copernicus Marine Service Information, accessed through the Copernicus Marine Toolbox API. Salinity, sea surface temperature, and current speed and direction were obtained from the Global Ocean Physics Reanalysis (GLORYS12V1), which provides data at a 1/12° horizontal resolution with 50 vertical levels [@GLORYS12V1]. Wind speed and direction at the surface were obtained from the Global Ocean Hourly Reprocessed Sea Surface Wind and Stress from Scatterometer and Model dataset, available at 0.125° horizontal spatial resolution and hourly frequency [@WIND_GLO_PHY]. Chlorophyll-a concentrations were obtained from the Global Ocean Colour dataset, which provides data at ~4 km horizontal resolution [@GlobColour]. All environmental data were retrieved daily (hourly in the case of winds) for the 2012–2024 period, covering the Chilean Exclusive Economic Zone (EEZ) between 32°S and 41°S.
 

 
  - Future (2040–2050):
          - OracleBio -- Unfurtunally only decadal projections for different scenarios for SST, salinity, currents and chlorophyll (4km resolution) -- no winds;
          - CMIP6 for winds? (~100 km).
        
-   **POR SOLICITAR:**
   -   Other data?
        -   Average wage pay to crew member per hour
        -   Diesel cost.
        -   Permits by vessels
        -   Quota prices?
-   @Birkenbach2024:
    -   *Day at sea price captures elements of forward-looking behavior
        and information. @reimer2022structural similarly argue that
        including a quota price captures forward looking behavior and
        allows one to simplify the dynamic model to a static one.*
    -   *Data on wind speed and direction were collected from NOAA’s
        National Center for Atmospheric Prediction’s high-resolution
        North American Regional Reanalysis dataset and averaged to the
        daily level for each stock centroid location, defined as gear
        and month-specific average latitudes and longitudes where
        fishing occurs for each stock.*
        
- Also
  - Quota price? Auction market but also secondary market if available
  - Quota level, by area/fishing organization for Artisanal, and TAC for industrial with ITQ levels by vessel?
  - If no data, mybe intrapolate prices from other auctions????
  - Reallocations of quotas?
  
  

## Econometrics models

### Stock dynamics

To estimate stock dynamics, we use annual data on stock abundance and vessel landings. Following @Kasperski2015-jm, the base model for the growth of each species follows a discrete logistic function: 
\begin{equation}
x_{i,y+1} + h_{iy} = \underbrace{(1 + r_i)x_{iy} + \eta_i x_{iy}^2}_{R_i(x_{iy})} + \underbrace{\sum_{j \neq i}^{n-1} a_{ij} x_{iy} x_{jy}}_{I_i(x_y)} \quad i=1,\ldots,n
\label{eq1}
\end{equation}
where $x_{iy}$ is the fish stock by species $i=1,\ldots,n$ in year $y$, $n$ is the total number of species, $h_{iy}$ is the annual harvest of species $i$ on year $y$, $r_i$ is the intrinsic growth rate of the resource $i$, $\eta_i$ is a density-dependent factor related to the carrying capacity, and $\alpha_{ij}$ are the interaction parameters between species. The system of $n$ growth equations is estimated simultaneously using seemingly unrelated regression (SUR). Following @Richter2018, we augment \eqref{eq1} by including environmental covariates $Env_{iy}$ that affect the fish stock and an error term $\varepsilon_{iy}$ that captures random recruitment: 
\begin{equation}
x_{i,y+1} + h_{iy} = \underbrace{(1 + r_i)x_{iy} + \eta_i x_{iy}^2}_{R_i(x_{iy})} + \underbrace{\sum_{j \neq i}^{n-1} a_{ij} x_{iy} x_{jy}}_{I_i(x_y)} + \rho_i Env_{iy} + \varepsilon_{iy} \quad i=1,\ldots,n
\label{eq2}
\end{equation} 
where $\rho_i$ are the coefficient for the environmental covariates. Specifically, we included as environmental covariates the sea surface temperature and chlorophyll levels averages for the South-Central chile region. We include only data within the EEZ Chilean region and 


As shown in Figure \@ref(fig:biomass), biomass levels vary by species,
and there is some interrelation between them. It is also clear that
these biomass levels are affected by the harvests that occurred during
those periods. For instance, in the case of jack mackerel, an abrupt
decline in biomass is observed, likely due to a combination of
overexploitation of the resource and unfavorable environmental
conditions.

-   From [@Yáñez2014]:
    -   *"@Fuenzalida2007 forecast that surface winds would strengthen
        in the coast of Chile, with an increase of 6 m/s in some areas
        of Chile during the period 2046-2065 in comparison to 2000–2005;
        this might increase upwelling and thus, fisheries productivity
        [@garreaud2009]."*
        -   *"Wind direction and strength will probably influence the
            distribution and abundance of marine species. Small and
            coastal pelagic species, for example, show different
            behaviors: while anchovy maximizes recruitment at current
            speeds of 5.46 m/s, showing an important decrease with lower
            and higher values, sardine maximizes recruitment at 5.63 m/s
            or more [@yanez2001].*
    -   *Anchovy dominates during cold inter-decadal periods, while
        sardine prevail during warm inter-decadal periods. Such
        interdecadal variations in SST also influence recruitment, a
        situation that has been documented in anchovies off the Peruvian
        coast [@cahuin2009]."*
        -   *Longer term predictions based on two global warming
            scenarios of the IPCC (Intergovernmental Panel on Climate
            Change) done by @Fuenzalida2007 shows a warming on the
            Chilean coast."*

```{r biomass, echo=FALSE, fig.align='center', fig.cap="Estimated biomass of small pelagic species in Chile (2000–2024)", fig.pos='ht!', message=FALSE, warning=FALSE}

library(ggplot2)
library(tidyr)
library(scales)
library(viridis)

biomass_long <- biomass %>%
  pivot_longer(cols = c(sardine_biomass, anchoveta_biomass, jurel_biomass_cs, , jurel_biomass_cs_intra),
               names_to = "species", 
               values_to = "biomass") %>%
  filter(!is.na(biomass)) %>%
  arrange(species, year)

biomass_long$biomass <- as.numeric(biomass_long$biomass)
biomass_long$year <- as.numeric(biomass_long$year)
biomass_long$species <- recode(biomass_long$species,
                               sardine_biomass = "Sardine", 
                               anchoveta_biomass = "Anchoveta", 
                               jurel_biomass_cs = "Jack Mackerel", 
                               jurel_biomass_cs_intra = "Jack Mackerel (intrapolated)")

biomass <- biomass_long %>% filter(species %in% c("Sardine", "Anchoveta", "Jack Mackerel", "Jack Mackerel (intrapolated)"))


# Plot
ggplot(biomass, aes(x = year, y = biomass, color = species, group = species)) +
  geom_smooth(se = TRUE, method = "loess", span = 0.4, linetype = "solid") +
  scale_y_continuous(labels = scales::comma) +  # Or use scale_y_log10(labels = comma) to compress
  labs(x = "Year",
       y = "Biomass (tons)",
       color = "Species") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.y = element_text(angle = 0, hjust = 1),
    legend.position = "right" 
  ) + 
  scale_color_viridis_d(option = "D")


rm(list = c("biomass_long"))

```

Adding harvest:

```{r harvestbiomass, echo=FALSE, fig.align='center', fig.cap="Estimated biomass vs harvest of small pelagic species in CentralSouth Chile (2000–2024)", fig.pos='ht!', message=FALSE, warning=FALSE}

library(tidyverse)

harvest2 <- harvest %>%
  select(c(specie, year, total_harvest_IFOP_centrosur)) %>%
  mutate(specie = recode(specie,
                          "SARDINA COMUN" = "Sardine",
                          "JUREL" = "Jack Mackerel",
                          "ANCHOVETA" = "Anchoveta"
                          )) %>%
  rename(harvest = total_harvest_IFOP_centrosur) %>%
  rename(species = specie)

harvest2 <- bind_rows(
  harvest2,
  harvest2 %>%
    filter(species == "Jack Mackerel") %>%
    mutate(species = "Jack Mackerel (intrapolated)")
)

biomass_harvest <- full_join(biomass, harvest2, by = c("species" = "species", "year" = "year")) %>% arrange(species, year)

biomass_harvest_long <- biomass_harvest %>%
  pivot_longer(cols = c(biomass, harvest),
               names_to = "variable",
               values_to = "value")

ggplot(biomass_harvest_long, aes(x = year, y = value, color = variable)) +
  # geom_line(size = 1, na.rm = TRUE) +  
  # geom_point(size = 2, na.rm = TRUE) + 
  geom_smooth(se = FALSE, span = 0.4, method = "loess", na.rm = TRUE) + # <- smoothing
  facet_wrap(~species, scales = "free_y") +
  labs(x = "Year", y = "Value (tons)", color = "Variable") +
  scale_color_manual(values = c("biomass" = "darkgreen", "harvest" = "steelblue")) +
  theme_minimal() +
  theme(legend.position = "top")

```

### Trip level cost functions

Ignoring trip subscript, the cost functions vary by vessel
$v=1,\ldots,V_g$ and gear used $g=1,\ldots,G$, where $V_g$ is the number
of observations using gear type $g$, and $G$ is the total number of
available (or observed) gears: \begin{equation}
C_{vg} = \sum_{i=1}^{2n+M+k} \alpha_{g, \mathbf{X}_i} \mathbf{X}_{ivg} + \frac{1}{2} \sum_{i=1}^{2n+M+k} \sum_{j=1}^{2n+M+k} \alpha_{g, \mathbf{X}_i\mathbf{X}_j} \mathbf{X}_{ivg} \mathbf{X}_{jvg}
\label{eq3}
\end{equation} where $C_{vg}= w z_{vg}^*$,
$\mathbf{X}_{vg}=[w;h_{vg};x;Z_v]$, $w$ is a $V_g \times M$ matrix of
variable input prices, $h_{vg}$ is an $V_g \times n$ matrix of harvest
quantities, $x$ is an $V_g \times n$ matrix of given stock levels of the
species of interest, and $Z_v$ is an $V_g \times k$ matrix of given
vessel characteristics. Therefore, $\mathbf{X}_{vg}$ is a
$V_g \times (2n+M+k)$ matrix, and $\mathbf{X}_{ivg}$ represents the
*i*th column of the $\mathbf{X}_{vg}$ matrix.

Together with estimating the restricted cost function, we estimate the
conditional input demand equations. This addition allows an increase in
the degrees of freedom by imposing cross-equation parameter constraints
and allows for the testing of, for instance, jointness in inputs
[@Kasperski2015-jm]. The conditional input demand equations are derived
by Shepard's Lemma: \begin{equation}
\frac{\partial C_{vg}}{\partial w_m} = z^*_{vg,w_m} = \alpha_{g,w_m} + \sum_{j=1}^{2n+M+k} \alpha_{g,w_m,\mathbf{X}_j} \mathbf{X}_{jvg} \quad m=1,\ldots,M.
\label{eq4}
\end{equation}

Similar to stock dynamics, the system of equations formed by \eqref{eq3}
and \eqref{eq4} can be estimated using SUR. To comply with economic
theory, and to reduce even more the number of parameters to estimate,
the following restrictions are imposed when estimating \eqref{eq4}:

1.  Symmetry of the cost function, where \begin{equation*}
      \alpha_{g,\mathbf{X}_i\mathbf{X}_j} = \alpha_{g,\mathbf{X}_j\mathbf{X}_i} \quad \forall \quad i=1,\ldots,(2n + M + k); \ i \neq j; \ g = 1,\ldots, G.
      \end{equation*}

2.  Linear homogeneity in input prices, where \begin{equation*}
      \sum_m^M \alpha_{g,w_m} = 1 \ \text{and} \ \sum_m^M \alpha_{g,w_m,\mathbf{X}_i} = 0 \quad i=1,\ldots,(2n + M + k); \ g = 1,\ldots, G.
      \end{equation*}

Data at the trip level is available upon request from the Chilean
Fisheries Research Institute (IFOP), which registers geo-referenced
catch information on the Chilean fleet's fishing operation per trip [see
e.g. @Pena-Torres2017-gn and [IFOP data
observatory](ifop.dataobservatory.net)]. As inputs we can use the time
spent at sea during a trip, where the price is the average wage pay to
crew member per hour, and the distance traveled during a trip, where the
price of distance traveled is the diesel cost. Therefore, the total cost
function $C_{vg}= w z_{vg}^*$ for vessel $v$, using gear $g$ in a trip
would be sum of the total cost of distance travelled plus the total cost
of the time spent at sea.

**Note:** *Depending on the type of vessel, this cost should change.
Some vessels are more efficient, other one are more heavy. How to
capture this? The righ hand side has vessel characteristics, so the
effect of harvest would be conditional on vessel characteristics, the
stock levels and input prices. As we only care in the margin how harvest
increase cost, this should be fine. @Kasperski2015-jm mention this
"...no reliable fixed cost information on these vessels exists, but
these should not affect the optimization as economic decisions are made
at the margin. Therefore, this study does not measure true profit, but
rather a proxy based on the net operating rent accruing to vessels in
the fishery."*

To link this function to climate change, we can also include additional
environmental variables $Env$ to $\mathbf{X}_{vg}$ such as wind
intensity and wave conditions in each trip at the harvest location, upon
data availability. Therefore, the augmented $X_{vg}$ matrix becomes
$\mathbf{X}^{'}_{vg} = [w;h_{vg};x;Z_v;Env]$.

MAYBE INCLUDE QUOTA PRICE? **Higher quota prices for depleted stocks
(e.g., GOM cod) reduce incentives to target them.** and **Active leasing
markets for quota (and previously for DAS) allow fishermen to treat
quota as a "priced input" rather than a fixed, exhaustible resource.**


Add
  - liters/hours x hours trip x fuel price
  - crew member x harvest x price x share
  - certification cost per landed ton x landing

### Total annual trips

The number of trips a vessel will take in a given year for each gear
type used is assumed to follow a Poison distribution
[@Kasperski2015-jm]: \begin{equation}
Pr\left[T^{*}_{vgy} = t_v\right] = \frac{exp^{-exp(U^{'}_{vg}\beta_g)}exp(U^{'}_{vg}\beta_g)^{t_v}}{t_v !}
\label{eq5}
\end{equation} where $U_{vg}=[p,w,h_{vg},\bar{q},Z_{vg}]$ is a
$(3n+M+k+1)×V_g$ matrix of explanatory variables, $\beta_g$ is a
$(3n+M+k+1)\times1$ matrix of coefficients to be estimated, $t_v$ is the
number of trips taken by vessel $v$ using gear type $g$ in year $y$, and
$\bar{q}$ is the annual quota level. Additionally, we can add the
accumulation of "bad weather days" as an explanatory variable to
incorporate weather conditions into this decision, thus
$U_{vg}=[p,w,h_{vg},\bar{q},Z_{vg}, Env]$

### Inverse demand model for outputs

The price of each species is modeled using an inverse demand model,
which assumes weak separability between the species into consideration
and other products [@Kasperski2015-jm]. The price of a species $i$ in
year $y$ is the following:

\begin{equation}
p_{iy} = \sum_j^n \gamma_j p_{j,y-1} + \gamma_{h_i} h_{iy} + \epsilon_{iy}, \quad i = 1,\ldots,n, \ j = 1,\ldots,n.
\label{eq6}
\end{equation}

The system formed by \eqref{eq6} can be estimated using maximum
likelihood. Note that harvest may be endogenous in this system due to
simultaneity. @Kasperski2015-jm solves this by assuming that the TAC is
exogenous, and the catch, in general, is determined by this quota. We
can relax this assumption by considering that all variables in the
inverse demand equations are endogenous by estimating a vector
autoregressive (VAR) model [@juselius2006cointegrated]. In other words,
harvest $h_{vg}$ has its own equations in the system.

```{=html}
<!-- Comment: One concern I have regards the endogeneity of factors determining the outcomes of fishing effort on a fishing
trip (where, when, how long, and for what, and how much), climate conditions (temperature, wave, and wind),
and input and output prices. While Kasperski assumes that total allowable catches are binding to avoid one potential endogeneity, I wonder if this is a good assumption under climate change. What would you need to assume about the regulator’s response to the changing conditions and the setting of the total allowable catches? -->
```

## Numerical optimization

To obtain the effect of future climate variability on stock, harvest,
quota and profits, we conduct numerical optimization for different
climate scenarios using the parameters estimates for the stock dynamic,
cost functions, total annual trips and inverse demand equations. In each
year, a vessel maximizes profits by choosing their optimal number of
trips $T_g$ and harvest levels per trip $h_{g\tau}$ given a gear type:
\begin{align}
\max_{h_{gt}, T_g} \quad \pi_{vgt} & = \sum_{\tau=t}^{T_g} \rho^\tau \left\{ P(h) h_{g\tau} - C_g(h_{g\tau} | w, x, Z, Env) \right\} \quad \tau = t,\ldots, T_g \nonumber \\
\textbf{s.t} \quad q_{g,t+1} & = \omega \ast \bar{q} - \sum_{t=1}^{t} h_{gt} \geq 0, \quad t = 1, \dots, T-1, \quad g = 1, \dots, G
\label{eq7}
\end{align} where $\rho$ is the intra-annual discount factor, $\omega$
is a vector of shares of $\bar{q}$, and $h_{lt}=0$ for all $l\neq g$.
The vector of shares is obtained from historical data on harvest. The
optimal profit from the maximization problem in \eqref{eq7} is denoted
as $\pi_{vgy}^* (p,w,x,Z,\bar{q},\omega, Env)$, and $h_{vgty}^*$ and
$T_{vgy}^*$ are the optimal choices harvest per trip and total number of
trips in year $y$ for vessel $v$. To obtain the optimal quota level, we
must solve the social-planner optimization problem to maximize the net
value of the fishery by choosing the quota levels per year and by
species.

Following @Kasperski2015-jm, the optimization problem will be conducted
for the next 25 years. I will use different climate scenarios and
compare different optimal outcomes between them by using future
projections for the environmental variables included in the model.

## Projections

*From [@Yáñez2014]*:

-   "To project the model, the average structure of catches and temperature (of Antofagasta and the region Niño 3 + 4) for the years 2005, 2006 and 2007 were used as starting point. We consider a linear increase in temperature, taking into account four climate change scenarios based on the scenarios presented by IPCC, designed for the northern part of Chile until 2100.
    1.  The first scenario considers an increase in temperature of 0.034ºC per year [@Fuenzalida2007], similar to that estimated by @Trenberth2007.
    2.  A second scenario, more moderate, of 0,025ºC/year is also proposed by @Fuenzalida2007.
    3.  The third scenario is not considered a significant effect on the area, following the work of @Trenberth2007.
    4.  The fourth scenario is contradictory, indicating a cooling de 0.02 ºC/year [@falvey2009]. It should be noted that according to the work of @Fuenzalida2007 and @falvey2009 the same SST increase (or decrease) were considered for both temperatures (in Antofagasta and in the Niño 3 + 4 region)."

# Results

NO RESULTS YET

# Discussion

If ITQ in this fishery in Chile: **The theoretical findings on multispecies harvest patterns in @Birkenbach2020-nh give rise to nuanced hypotheses about how behavior and outcomes will change after the adoption of catch shares. For example, a secure property right to catch fish at any time in the fishing season allows firms to spread the catch of stocks with high prices and downward-sloping demand over a longer fishing season. This minimizes market gluts that steer product toward lower priced frozen markets [@homans2005] and can result in higher prices for those species. Fishermen might also shift their efforts toward lower-priced species with cheaper quota or toward non-catch-share fisheries, intensifying the race to fish for those species during
portions of the season [@asche2007; @cunningham2016spillovers].** -- However, we do not include other species than jack mackerel, sardine and anchovy that might be caught by thise fleet. This would require to expand the model by **N** species, which would increase dimensionality of the model. WE NEED PERMITS TO CHECK IF ACTUALLY THIS HAPPEN! (Still problem with Open-Access)

## Potential extension of the project

Several other extensions to the model can be incorporated to be improved. For instance, the geographical space where fishermen operate is relevant, as depending on the location chosen and when to participate, the set of potential choices would vary [@Reimer2017-jw]. As I mentioned above, it is possible to extend the stock dynamic model by considering different locations. The model would also require that the participation decision, which is captured by the Poisson model on the annual number of trips, should then consider the decision to participate in a determined fishing ground, connecting the multi-species model of @Kasperski2015-jm to the literature of location choice modeling [e.g., @Dupont1993-jn; @Smith2005-us; @Hicks2020-mz].

## Damage function for the fisheries sector

Link to the work made in the U.S. West Coast. Similar weather, but different development. We would need to also have estimate of the dose-response function in other latitudes, with significantly different temperatures...

# Conclusions

NO CONCLUSION YET


## Future research question

- Does higher quota allocation of jack mackerel, a predator for anchovy and sardine, helps small scale sector actually?


# Repository

The source code for this project is available on
[GitHub](https://github.com/fquezadae/Impact-of-Environmental-Variability-on-Harvest)

# References
